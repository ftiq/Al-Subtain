<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>

    <record id="form_intake_paperformat" model="report.paperformat">
      <field name="name">Form Intake A4</field>
      <field name="format">A4</field>
      <field name="orientation">Portrait</field>
      <field name="margin_top">50</field>
      <field name="margin_bottom">35</field>
      <field name="margin_left">7</field>
      <field name="margin_right">7</field>
      <field name="header_line" eval="False"/>
      <field name="header_spacing">35</field>
      <field name="dpi">90</field>
      <field name="disable_shrinking" eval="True"/>
    </record>

    <template id="form_intake_template">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="move">
          <t t-call="custom_report_layout.custom_external_layout">
            <t t-call="appointment_financial_report.form_intake_page"/>
          </t>
        </t>
      </t>
    </template>

    <template id="form_intake_page">
      <div class="page" t-att-dir="is_rtl and 'rtl' or 'ltr'" style="font-family: Arial, sans-serif;">
        <meta charset="UTF-8"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <style>
          * { font-family: Arial, sans-serif !important; }
          .page { padding: 15mm 0 25mm 0; }
          .title{ text-align:center; font-size:16px; font-weight:bold; color:#000; border:2px solid #424242; padding:6px; border-radius:6px; background:#f5f5f5; }
          .grid { width:100%; border-collapse:collapse; }
          .grid td { border:1px solid #424242; padding:6px; font-size:12px; }
          .lbl { background:#e0e0e0; font-weight:bold; width:15%; }
          .tbl { width:100%; border-collapse: collapse; margin-top:6px; border:2px solid #424242; }
          .tbl thead th{ background:#f0f0f0; border:1px solid #424242; text-align:center; padding:5px; font-size:12px; }
          .tbl tbody td{ border:1px solid #757575; text-align:center; padding:5px; font-size:12px; }
          .tbl tfoot td{ border:1px solid #424242; text-align:center; padding:6px; font-weight:bold; background:#f5f5f5; }
          .note { margin-top:8px; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:12px; }
          .signs{ margin-top:12px; }
          .signs table{ width:100%; border-collapse:collapse; }
          .signs td{ text-align:center; border:2px dashed #90a4ae; padding:10px; border-radius:6px; }
          .meta{ margin-top:8px; font-size:10px; color:#666; display:flex; justify-content:space-between; }
        </style>

        <t t-set="rows" t-value="get_invoice_rows(move)"/>
        <t t-set="total_amount" t-value="move.amount_total or 0.0"/>
        <t t-set="rows_total" t-value="sum([r['subtotal'] for r in rows]) if rows else (move.amount_untaxed or 0.0)"/>
        <t t-set="paid" t-value="(move.amount_total or 0.0) - (move.amount_residual or 0.0)"/>
        <t t-set="due" t-value="move.amount_residual or 0.0"/>

        <div class="title">استمارة استلام نموذج</div>

        <table class="grid" style="margin-top:6px;">
          <tr>
            <td class="lbl">رقم الاستمارة</td>
            <td style="width:20%" t-esc="move.name or ''"/>
            <td class="lbl">التاريخ</td>
            <td style="width:20%" t-esc="(move.invoice_date or move.date) and (move.invoice_date or move.date).strftime('%d/%m/%Y') or ''"/>
            <td class="lbl">العملة</td>
            <td style="width:15%" t-esc="move.currency_id and move.currency_id.name or ''"/>
          </tr>
          <tr>
            <td class="lbl">العميل</td>
            <td colspan="2" style="width:30%" t-esc="move.partner_id and move.partner_id.display_name or ''"/>
            <td class="lbl">هاتف</td>
            <td colspan="2" style="width:35%" t-esc="get_partner_phone(move)"/>
          </tr>
          <tr>
            <td class="lbl">رقم الكتاب</td>
            <td t-esc="get_book_number(move)"/>
            <td class="lbl">المشروع</td>
            <td colspan="3" t-esc="get_project_name(move)"/>
          </tr>
          <tr>
            <td class="lbl">المبلغ الكلي</td>
            <td t-esc="'{:,.2f}'.format(total_amount)"/>
            <td class="lbl">المبلغ المقبوض</td>
            <td t-esc="'{:,.2f}'.format(paid)"/>
            <td class="lbl">المتبقي</td>
            <td t-esc="'{:,.2f}'.format(due)"/>
          </tr>
        </table>

        <table class="tbl">
          <thead>
            <tr>
              <th style="width:6%">م.</th>
              <th>نوع الفحص</th>
              <th style="width:12%">السعر</th>
              <th style="width:10%">العدد</th>
              <th style="width:14%">الإجمالي</th>
            </tr>
          </thead>
          <tbody>
            <t t-foreach="rows" t-as="r">
              <tr>
                <td t-esc="r['seq']"/>
                <td style="text-align:right; padding-right:8px">
                  <div t-esc="r['name']"/>
                  <div t-if="r.get('exec')" style="font-size:10px; color:#555;">المنفذ: <t t-esc="r.get('exec')"/></div>
                </td>
                <td t-esc="'{:,.2f}'.format(r['price_unit'])"/>
                <td>
                  <div t-esc="'{:,.2f}'.format(r['qty'])"/>
                  <div t-if="r.get('samples')" style="font-size:10px; color:#555;">نماذج: <t t-esc="'{:,.0f}'.format(r.get('samples'))"/></div>
                </td>
                <td t-esc="'{:,.2f}'.format(r['subtotal'])"/>
              </tr>
            </t>
            <t t-if="not rows">
              <tr>
                <td colspan="5" style="text-align:center; color:#999; font-style:italic">لا توجد بنود</td>
              </tr>
            </t>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4">المجموع (بدون ضريبة)</td>
              <td t-esc="'{:,.2f}'.format(rows_total)"/>
            </tr>
            <tr>
              <td colspan="4">الضريبة</td>
              <td t-esc="'{:,.2f}'.format(move.amount_tax or ((total_amount or 0.0) - (move.amount_untaxed or 0.0)))"/>
            </tr>
            <tr>
              <td colspan="4">الإجمالي</td>
              <td t-esc="'{:,.2f}'.format(total_amount)"/>
            </tr>
          </tfoot>
        </table>

        <div class="note">
          <strong>المبلغ كتابة:</strong>
          <span t-esc="amount_to_text_ar(move.amount_total or 0.0, move.currency_id)"/>
        </div>

        <div t-if="move.narration" class="note">
          <strong>ملاحظات:</strong>
          <span t-esc="move.narration"/>
        </div>

        <div class="signs">
          <table>
            <tr>
              <td>مقدم الاستمارة</td>
              <td>قسم النماذج</td>
              <td>المحاسب</td>
              <td>المدير</td>
            </tr>
          </table>
        </div>

        <div class="meta">
          <div>
            Print Time: <t t-esc="print_datetime and print_datetime.strftime('%H:%M:%S %d/%m/%Y') or ''"/>
            &#160; | &#160; Print By: <t t-esc="user and user.name or ''"/>
          </div>
          <div>Page <span class="page"/> / <span class="topage"/></div>
        </div>
      </div>
    </template>

    <record id="form_intake_action" model="ir.actions.report">
      <field name="name">استمارة</field>
      <field name="model">account.move</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">appointment_financial_report.form_intake_template</field>
      <field name="binding_model_id" ref="account.model_account_move"/>
      <field name="binding_type">report</field>
      <field name="paperformat_id" ref="appointment_financial_report.form_intake_paperformat"/>
      <field name="print_report_name">(object.name or 'Form') + '-' + ((object.invoice_date or object.date) and (object.invoice_date or object.date).strftime('%Y%m%d') or '')</field>
    </record>

  </data>
</odoo>
