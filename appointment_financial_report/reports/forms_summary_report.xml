<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>

    <record id="forms_summary_paperformat" model="report.paperformat">
      <field name="name">Forms Summary A4</field>
      <field name="format">A4</field>
      <field name="orientation">Landscape</field>
      <field name="margin_top">25</field>
      <field name="margin_bottom">20</field>
      <field name="margin_left">7</field>
      <field name="margin_right">7</field>
      <field name="header_line" eval="False"/>
      <field name="header_spacing">20</field>
      <field name="dpi">90</field>
      <field name="disable_shrinking" eval="True"/>
    </record>

    <template id="forms_summary_template">
      <t t-call="web.html_container">
        <t t-set="body_classname" t-value="'o_report_layout_standard'"/>
        <t t-foreach="docs" t-as="wiz">
          <div class="header">
            <div style="text-align: center;">
              <h3>ملخص النماذج</h3>
            </div>
          </div>
          <div class="article">
            <t t-call="appointment_financial_report.forms_summary_page"/>
          </div>
          <div class="footer">
            <div style="text-align: center;">
              صفحة <span class="page"/> من <span class="topage"/>
            </div>
          </div>
        </t>
      </t>
    </template>

    <template id="forms_summary_page">
      <div class="page" t-att-dir="is_rtl and 'rtl' or 'ltr'" style="font-family: Arial, sans-serif;">
        <meta charset="UTF-8"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <style>
          * { font-family: Arial, sans-serif !important; }
          .page { 
            padding: 2mm 0 18mm 0; 
            margin: 0; 
            min-height: 280mm; 
          }
          .title{ text-align:center; font-size:14px; font-weight:bold; color:#000; border:1px dashed #90a4ae; padding:3px; border-radius:4px; background:#f5f5f5; }
          .filters{ margin:4px 0 6px 0; text-align:center; }
          .filters span{ display:inline-block; min-width:100px; margin:0 4px; padding:2px 6px; border:1px solid #b0bec5; border-radius:4px; background:#fff; font-size:10px; }
          .section-title{ margin:6px 0 2px 0; text-align:left; }
          .section-title .box{ display:inline-block; border:2px solid #424242; padding:2px 6px; border-radius:3px; font-weight:bold; background:#fafafa; font-size:11px; }
          table.grid{ width:100%; border-collapse:collapse; margin-bottom:4px; }
          table.grid th, table.grid td{ border:1px solid #424242; padding:3px; text-align:center; font-size:9px; color:#000; }
          table.grid thead th{ background:#e0e0e0; font-weight:bold; font-size:10px; }
          .totals{ font-weight:bold; color:#000; background:#fffbe6; font-size:9px; }
          .grand{ margin-top:8px; padding:4px; border:2px solid #424242; border-radius:4px; background:#f5f5f5; }
          /* Keep section blocks together and compress spacing */
          thead { display: table-header-group; }
          tfoot { display: table-footer-group; }
          .section { page-break-inside: avoid; margin-bottom: 4px; }
          /* Keep header visible and normal */
          .page-header { 
            page-break-inside: avoid; 
            margin-bottom: 6px;
          }
          /* Simple page footer */
          .simple-footer { 
            position: fixed; 
            bottom: 5mm; 
            left: 50%; 
            transform: translateX(-50%);
            font-size: 10px; 
            color: #666; 
            background: white;
            padding: 2px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            z-index: 1000;
          }
          @media print {
            @page { 
              margin: 10mm 7mm 15mm 7mm; 
              size: A4 landscape;
            }
            body { margin: 0; padding: 0; }
            .page { min-height: auto; }
          }
        </style>

        <div class="filters" style="margin:10px 0; text-align:center;">
          <span>من: <t t-esc="date_from and date_from.strftime('%Y/%m/%d') or ''"/></span>
          <span>إلى: <t t-esc="date_to and date_to.strftime('%Y/%m/%d') or ''"/></span>
          <span>الشركة: <t t-esc="(company and company.display_name) or (docs and docs[0].company_id.display_name) or ''"/></span>
        </div>

        <t t-foreach="sections" t-as="sec">
          <div class="section">
          <div class="section-title"><span class="box">رقم النموذج: <t t-esc="sec['form_no']"/></span></div>
          <table class="grid">
            <thead>
              <tr>
                <th style="width:3%">No.</th>
                <th style="width:7%">Date</th>
                <th style="width:14%">Customer</th>
                <th style="width:10%">Book Number</th>
                <th style="width:8%">Total</th>
                <th style="width:8%">Paid</th>
                <th style="width:8%">Due</th>
                <th style="width:10%">Test Type</th>
                <th style="width:12%">Executed By</th>
                <th style="width:14%">Project</th>
                <th style="width:5%">Qty</th>
                <th style="width:6%">Unit Price</th>
              </tr>
            </thead>
            <tbody>
              <t t-foreach="sec['rows']" t-as="r">
                <tr>
                  <td t-esc="r['seq']"/>
                  <td t-esc="r['date'] and r['date'].strftime('%Y/%m/%d') or ''"/>
                  <td t-esc="r['partner']"/>
                  <td t-esc="r.get('book_number','')"/>
                  <td t-esc="format_amount(r['currency'], r['total'])"/>
                  <td t-esc="format_amount(r['currency'], r['paid'])"/>
                  <td t-esc="format_amount(r['currency'], r['due'])"/>
                  <td t-esc="r.get('test_type','')"/>
                  <td t-esc="r['exec_side']"/>
                  <td t-esc="r['project']"/>
                  <td t-esc="r['count']"/>
                  <td t-esc="format_amount(r['currency'], r['price'])"/>
                </tr>
              </t>
            </tbody>
            <tfoot>
              <tr class="totals">
                <td colspan="10" style="text-align:right">Form Total</td>
                <td t-esc="sec['totals']['count']"/>
                <td>
                  <t t-set="cur" t-value="sec['rows'] and sec['rows'][0]['currency'] or (docs and docs[0].company_id.currency_id)"/>
                  <t t-esc="format_amount(cur, sec['totals']['total'])"/>
                </td>
              </tr>
            </tfoot>
          </table>
          </div>
        </t>

      </div>
    </template>

    <record id="forms_summary_report_action" model="ir.actions.report">
      <field name="name">Forms Summary</field>
      <field name="model">forms.summary.wizard</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">appointment_financial_report.forms_summary_template</field>
      <field name="paperformat_id" ref="appointment_financial_report.forms_summary_paperformat"/>
      <field name="print_report_name">'Forms-Summary-' + (object.date_from or '') + '-' + (object.date_to or '')</field>
    </record>

  </data>
</odoo>
