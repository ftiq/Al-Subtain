<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">

        <!-- Additional UOM Categories and Units for Bitumen Tests -->
        <record id="uom_categ_temperature_ap" model="uom.category">
            <field name="name">درجة الحرارة</field>
        </record>

        <record id="uom_categ_penetration_ap" model="uom.category">
            <field name="name">عمق الاختراق</field>
        </record>

        <record id="uom_categ_elongation_ap" model="uom.category">
            <field name="name">الاستطالة</field>
        </record>

        <record id="uom_categ_softening_ap" model="uom.category">
            <field name="name">درجة الليونة</field>
        </record>

        <record id="uom_celsius_ap" model="uom.uom">
            <field name="name">°C</field>
            <field name="category_id" ref="uom_categ_temperature_ap"/>
            <field name="factor" eval="1.0"/>
            <field name="uom_type">reference</field>
        </record>

        <record id="uom_dmm_ap" model="uom.uom">
            <field name="name">dmm</field>
            <field name="category_id" ref="uom_categ_penetration_ap"/>
            <field name="factor" eval="1.0"/>
            <field name="uom_type">reference</field>
        </record>

        <record id="uom_centimeter_ap" model="uom.uom">
            <field name="name">سم</field>
            <field name="category_id" ref="uom_categ_elongation_ap"/>
            <field name="factor" eval="1.0"/>
            <field name="uom_type">reference</field>
        </record>

        <record id="uom_softening_degree_ap" model="uom.uom">
            <field name="name">°C</field>
            <field name="category_id" ref="uom_categ_softening_ap"/>
            <field name="factor" eval="1.0"/>
            <field name="uom_type">reference</field>
        </record>

        <!-- ==================== PENETRATION TEST TEMPLATE ==================== -->
        <record id="template_bitumen_penetration" model="lab.test.template">
            <field name="name">فحص الاختراق للقير</field>
            <field name="code">BITUMEN_PENETRATION</field>
            <field name="description">فحص عمق الاختراق للقير لتحديد درجة صلابته</field>
            <field name="standard_code">ASTM D5, AASHTO T49</field>
            <field name="industry_type">asphalt</field>
            <field name="state">active</field>
            <field name="sequence">10</field>
        </record>

        <!-- Individual penetration readings -->
        <record id="crit_pentest_1" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 1</field>
            <field name="code">PENTEST_1</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">10</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_2" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 2</field>
            <field name="code">PENTEST_2</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">11</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_3" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 3</field>
            <field name="code">PENTEST_3</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">12</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_4" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 4</field>
            <field name="code">PENTEST_4</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">13</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_5" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 5</field>
            <field name="code">PENTEST_5</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">14</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_6" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 6</field>
            <field name="code">PENTEST_6</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">15</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_7" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 7</field>
            <field name="code">PENTEST_7</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">16</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_8" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 8</field>
            <field name="code">PENTEST_8</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">17</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_pentest_9" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">القراءة 9</field>
            <field name="code">PENTEST_9</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">18</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <!-- Average penetration (computed field) -->
        <record id="crit_pentest_avg" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_penetration"/>
            <field name="name">متوسط الاختراق</field>
            <field name="code">PENTEST_AVG</field>
            <field name="test_type">computed</field>
            <field name="uom_id" ref="uom_dmm_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="is_input_field">False</field>
            <field name="is_computed_field">True</field>
            <field name="computation_formula"># حساب متوسط الاختراق بناءً على القراءات المتوفرة
def safe_value(val):
    if isinstance(val, (list, tuple)) and len(val) > 0:
        return val[0]
    elif isinstance(val, (int, float)):
        return val
    else:
        return 0

values = [safe_value(PENTEST_1), safe_value(PENTEST_2), safe_value(PENTEST_3), safe_value(PENTEST_4), safe_value(PENTEST_5), safe_value(PENTEST_6), safe_value(PENTEST_7), safe_value(PENTEST_8), safe_value(PENTEST_9)]
valid_values = [v for v in values if v > 0]
result = sum(valid_values) / len(valid_values) if valid_values else 0</field>
            <field name="depends_on_criteria_ids" eval="[(6,0,[ref('crit_pentest_1'), ref('crit_pentest_2'), ref('crit_pentest_3'), ref('crit_pentest_4'), ref('crit_pentest_5'), ref('crit_pentest_6'), ref('crit_pentest_7'), ref('crit_pentest_8'), ref('crit_pentest_9')])]"/>
            <field name="sequence">19</field>
            <field name="is_required">False</field>
            <field name="is_critical">True</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">True</field>
        </record>

        <!-- ==================== FLASH AND FIRE POINT TEST TEMPLATE ==================== -->
        <record id="template_bitumen_flash_fire" model="lab.test.template">
            <field name="name">فحص نقطة الوميض</field>
            <field name="code">BITUMEN_FLASH_FIRE</field>
            <field name="description">فحص نقطة الوميض ونقطة الاحتراق للقير</field>
            <field name="standard_code">ASTM D92, AASHTO T48</field>
            <field name="industry_type">asphalt</field>
            <field name="state">active</field>
            <field name="sequence">20</field>
        </record>

        <record id="crit_flash_point" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_flash_fire"/>
            <field name="name">نقطة الوميض</field>
            <field name="code">FLASH_POINT</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_celsius_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">10</field>
            <field name="is_required">True</field>
            <field name="is_critical">True</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">True</field>
        </record>


        <!-- ==================== DUCTILITY TEST TEMPLATE ==================== -->
        <record id="template_bitumen_ductility" model="lab.test.template">
            <field name="name">فحص الاستطالة</field>
            <field name="code">BITUMEN_DUCTILITY</field>
            <field name="description">فحص قابلية القير للاستطالة تحت ظروف محددة</field>
            <field name="standard_code">ASTM D113, AASHTO T51</field>
            <field name="industry_type">asphalt</field>
            <field name="state">active</field>
            <field name="sequence">30</field>
        </record>

        <record id="crit_ductility_1" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_ductility"/>
            <field name="name">القياس 1</field>
            <field name="code">DUCTILITY_TEST_1</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_centimeter_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">10</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_ductility_2" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_ductility"/>
            <field name="name">القياس 2</field>
            <field name="code">DUCTILITY_TEST_2</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_centimeter_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">11</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_ductility_3" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_ductility"/>
            <field name="name">القياس 3</field>
            <field name="code">DUCTILITY_TEST_3</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_centimeter_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">12</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <!-- Average ductility (computed field) -->
        <record id="crit_ductility_avg" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_ductility"/>
            <field name="name">متوسط الاستطالة</field>
            <field name="code">DUCTILITY_TEST_AVG</field>
            <field name="test_type">computed</field>
            <field name="uom_id" ref="uom_centimeter_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="is_input_field">False</field>
            <field name="is_computed_field">True</field>
            <field name="computation_formula"># حساب متوسط الاستطالة بناءً على القراءات المتوفرة
def safe_value(val):
    if isinstance(val, (list, tuple)) and len(val) > 0:
        return val[0]
    elif isinstance(val, (int, float)):
        return val
    else:
        return 0

values = [safe_value(DUCTILITY_TEST_1), safe_value(DUCTILITY_TEST_2), safe_value(DUCTILITY_TEST_3)]
valid_values = [v for v in values if v > 0]
result = sum(valid_values) / len(valid_values) if valid_values else 0</field>
            <field name="depends_on_criteria_ids" eval="[(6,0,[ref('crit_ductility_1'), ref('crit_ductility_2'), ref('crit_ductility_3')])]"/>
            <field name="sequence">13</field>
            <field name="is_required">False</field>
            <field name="is_critical">True</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">True</field>
        </record>

        <!-- ==================== SOFTENING POINT TEST TEMPLATE ==================== -->
        <record id="template_bitumen_softening" model="lab.test.template">
            <field name="name">فحص الليونة</field>
            <field name="code">BITUMEN_SOFTENING</field>
            <field name="description">فحص نقطة الليونة للقير (Ring and Ball test)</field>
            <field name="standard_code">ASTM D36, AASHTO T53</field>
            <field name="industry_type">asphalt</field>
            <field name="state">active</field>
            <field name="sequence">40</field>
        </record>

        <record id="crit_softening_1" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_softening"/>
            <field name="name">درجة 1</field>
            <field name="code">SOFTENING_1</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_softening_degree_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">10</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <record id="crit_softening_2" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_softening"/>
            <field name="name">درجة 2</field>
            <field name="code">SOFTENING_2</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom_softening_degree_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="sequence">12</field>
            <field name="is_required">True</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">False</field>
        </record>

        <!-- متوسط الليونة (حقل محسوب) -->
        <record id="crit_softening_avg" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_softening"/>
            <field name="name">متوسط الليونة</field>
            <field name="code">SOFTENING_AVG</field>
            <field name="test_type">computed</field>
            <field name="uom_id" ref="uom_softening_degree_ap"/>
            <field name="min_value">0</field>
            <field name="max_value">0</field>
            <field name="target_value">0</field>
            <field name="is_input_field">False</field>
            <field name="is_computed_field">True</field>
            <field name="computation_formula">
# تحويل القوائم إلى أرقام إذا لزم الأمر
def safe_value(val):
    if isinstance(val, (list, tuple)) and len(val) > 0:
        return val[0]
    elif isinstance(val, (int, float)):
        return val
    else:
        return 0

val1 = safe_value(SOFTENING_1)
val2 = safe_value(SOFTENING_2)
result = (val1 + val2) / 2 if val1 and val2 else 0
            </field>
            <field name="depends_on_criteria_ids" eval="[(6,0,[ref('crit_softening_1'), ref('crit_softening_2')])]"/>
            <field name="sequence">13</field>
            <field name="is_required">False</field>
            <field name="is_critical">False</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">True</field>
        </record>

        <!-- النتيجة النهائية لفحص الليونة (حقل محسوب) -->
        <record id="crit_softening_result" model="lab.test.criterion">
            <field name="template_id" ref="template_bitumen_softening"/>
            <field name="name">نتيجة فحص الليونة</field>
            <field name="code">SOFTENING_RESULT</field>
            <field name="test_type">computed</field>
            <field name="uom_id" ref="uom_softening_degree_ap"/>
            <field name="min_value">-1</field>
            <field name="max_value">110</field>
            <field name="target_value">50</field>
            <field name="is_input_field">False</field>
            <field name="is_computed_field">True</field>
            <field name="computation_formula">
# حساب المتوسط أولاً
def safe_value(val):
    if isinstance(val, (list, tuple)) and len(val) > 0:
        return val[0]
    elif isinstance(val, (int, float)):
        return val
    else:
        return 0

val1 = safe_value(SOFTENING_1)
val2 = safe_value(SOFTENING_2)
avg_temp = (val1 + val2) / 2 if val1 and val2 else 0

# تقييم النتيجة حسب المستويات
result = evaluate_softening_level(avg_temp) if avg_temp else 0
            </field>
            <field name="depends_on_criteria_ids" eval="[(6,0,[ref('crit_softening_1'), ref('crit_softening_2')])]"/>
            <field name="sequence">14</field>
            <field name="is_required">False</field>
            <field name="is_critical">True</field>
            <field name="is_global">False</field>
            <field name="is_summary_field">True</field>
        </record>


        <!-- ==================== COMPLETE BITUMEN TEST FLOW TEMPLATE ==================== -->
        <record id="bitumen_test_flow_template" model="lab.test.flow.template">
            <field name="name">خطة فحص القير الشاملة</field>
            <field name="description">اختراق → نقطة الوميض والاحتراق → استطالة → ليونة</field>
            <field name="allow_parallel_tests" eval="True"/>
        </record>

        <record id="bitumen_test_flow_stage1" model="lab.test.flow.template.line">
            <field name="template_id" ref="bitumen_test_flow_template"/>
            <field name="sequence">10</field>
            <field name="test_template_id" ref="template_bitumen_penetration"/>
            <field name="sample_qty">1</field>
        </record>

        <record id="bitumen_test_flow_stage2" model="lab.test.flow.template.line">
            <field name="template_id" ref="bitumen_test_flow_template"/>
            <field name="sequence">20</field>
            <field name="test_template_id" ref="template_bitumen_flash_fire"/>
            <field name="sample_qty">1</field>
        </record>

        <record id="bitumen_test_flow_stage3" model="lab.test.flow.template.line">
            <field name="template_id" ref="bitumen_test_flow_template"/>
            <field name="sequence">30</field>
            <field name="test_template_id" ref="template_bitumen_ductility"/>
            <field name="sample_qty">1</field>
        </record>

        <record id="bitumen_test_flow_stage4" model="lab.test.flow.template.line">
            <field name="template_id" ref="bitumen_test_flow_template"/>
            <field name="sequence">40</field>
            <field name="test_template_id" ref="template_bitumen_softening"/>
            <field name="sample_qty">1</field>
        </record>

        <!-- Sample Types for Bitumen -->
        <record id="bitumen_surfacing_type" model="lab.sample.type">
            <field name="name">قير تسطيح</field>
            <field name="code">BITUMEN_SURFACING</field>
            <field name="description">قير لطبقة التسطيح العلوية</field>
            <field name="sequence">40</field>
        </record>

        <record id="bitumen_base_type" model="lab.sample.type">
            <field name="name">قير أساس</field>
            <field name="code">BITUMEN_BASE</field>
            <field name="description">قير لطبقة الأساس السفلية</field>
            <field name="sequence">41</field>
        </record>

        <!-- Subtypes for Bitumen Surfacing -->
        <record id="bitumen_surfacing_subtype_standard" model="lab.sample.subtype">
            <field name="name">قير تسطيح عادي</field>
            <field name="code">SURFACING_STANDARD</field>
            <field name="sample_type_id" ref="bitumen_surfacing_type"/>
            <field name="description">قير تسطيح عادي للاستخدام في الطرق</field>
            <field name="sequence">10</field>
        </record>

        <record id="bitumen_surfacing_subtype_modified" model="lab.sample.subtype">
            <field name="name">قير تسطيح محسن</field>
            <field name="code">SURFACING_MODIFIED</field>
            <field name="sample_type_id" ref="bitumen_surfacing_type"/>
            <field name="description">قير تسطيح محسن بالبوليمر</field>
            <field name="sequence">20</field>
        </record>

        <!-- Subtypes for Bitumen Base -->
        <record id="bitumen_base_subtype_standard" model="lab.sample.subtype">
            <field name="name">قير أساس عادي</field>
            <field name="code">BASE_STANDARD</field>
            <field name="sample_type_id" ref="bitumen_base_type"/>
            <field name="description">قير أساس عادي للطبقة السفلية</field>
            <field name="sequence">10</field>
        </record>

        <record id="bitumen_base_subtype_heavy" model="lab.sample.subtype">
            <field name="name">قير أساس ثقيل</field>
            <field name="code">BASE_HEAVY</field>
            <field name="sample_type_id" ref="bitumen_base_type"/>
            <field name="description">قير أساس ثقيل للأحمال العالية</field>
            <field name="sequence">20</field>
        </record>


        <!-- Product Templates for Bitumen Samples -->
        <record id="product_bitumen_surfacing_sample" model="product.template">
            <field name="name">عينات - قير تسطيح</field>
            <field name="type">consu</field>
            <field name="is_sample_product">True</field>
            <field name="tracking">serial</field>
            <field name="sample_type_id" ref="bitumen_surfacing_type"/>
            <field name="test_flow_template_id" ref="bitumen_test_flow_template"/>
            <field name="categ_id" ref="product.product_category_all"/>
        </record>

        <record id="product_bitumen_base_sample" model="product.template">
            <field name="name">عينات - قير أساس</field>
            <field name="type">consu</field>
            <field name="is_sample_product">True</field>
            <field name="tracking">serial</field>
            <field name="sample_type_id" ref="bitumen_base_type"/>
            <field name="test_flow_template_id" ref="bitumen_test_flow_template"/>
            <field name="categ_id" ref="product.product_category_all"/>
        </record>

    </data>
</odoo>