<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data noupdate="0">

    <record id="template_ll_d4318" model="lab.test.template">
      <field name="name">فحص حد السيولة (ASTM D4318)</field>
      <field name="code">LL_D4318</field>
      <field name="industry_type">soil</field>
      <field name="state">active</field>
      <field name="sequence">68</field>
      <field name="applicable_sample_type_ids" eval="[(6,0,[ref('appointment_products.agg_quality_sample_type')])]"/>
    </record>

    <record id="crit_ll_nb_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">عدد الطرقات (LL)</field>
      <field name="code">NB_LL</field>
      <field name="test_type">numeric</field>
      <field name="sequence">1</field>
      <field name="is_required">True</field>
    </record>
    <record id="crit_ll_w1_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">وزن العلبة مع العينة الرطبة (غم) - LL</field>
      <field name="code">W1_LL</field>
      <field name="test_type">numeric</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">2</field>
      <field name="is_required">True</field>
    </record>
    <record id="crit_ll_w2_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">وزن العلبة مع العينة الجافة (غم) - LL</field>
      <field name="code">W2_LL</field>
      <field name="test_type">numeric</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">3</field>
      <field name="is_required">True</field>
    </record>
    <record id="crit_ll_w3_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">وزن العلبة (غم) - LL</field>
      <field name="code">W3_LL</field>
      <field name="test_type">numeric</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">4</field>
      <field name="is_required">True</field>
    </record>
    <record id="crit_ll_w4_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">وزن الماء (غم) - LL</field>
      <field name="code">W4_LL</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">5</field>
      <field name="computation_formula">result = (W1_LL or 0) - (W2_LL or 0)</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_ll_w1_ll'), ref('appointment_products.crit_ll_w2_ll')])]"/>
    </record>
    <record id="crit_ll_w5_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">وزن العينة الجافة (غم) - LL</field>
      <field name="code">W5_LL</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">6</field>
      <field name="computation_formula">result = (W2_LL or 0) - (W3_LL or 0)</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_ll_w2_ll'), ref('appointment_products.crit_ll_w3_ll')])]"/>
    </record>
    <record id="crit_ll_moisture_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">المحتوى الرطوبي لكل تجربة LL (%)</field>
      <field name="code">MC_LL_PERCENT</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_percent_ap"/>
      <field name="sequence">7</field>
      <field name="computation_formula">result = (((W4_LL or 0) / (W5_LL or 1)) * 100) if W5_LL else 0</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_ll_w4_ll'), ref('appointment_products.crit_ll_w5_ll')])]"/>
    </record>
    <record id="crit_ll_summary_ll" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="name">حد السيولة LL (%)</field>
      <field name="code">LL_PERCENT</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_percent_ap"/>
      <field name="sequence">20</field>
      <field name="is_global">True</field>
      <field name="is_summary_field">True</field>
      <field name="is_required">True</field>
      <field name="computation_formula">xs = []
ys = []
for i in range(1, 10):
    n = series_value_at('NB_LL', i)
    w = series_value_at('MC_LL_PERCENT', i)
    if n and n &gt; 0 and w and w &gt; 0:
        xs.append(log10(float(n)))
        ys.append(float(w))

npts = len(xs)
if npts &gt;= 2:
    sumx = sum(xs)
    sumy = sum(ys)
    sumxy = 0.0
    sumx2 = 0.0
    for j in range(npts):
        sumxy += xs[j] * ys[j]
        sumx2 += xs[j] * xs[j]
    denom = (npts * sumx2) - (sumx * sumx)
    if denom != 0:
        m = ((npts * sumxy) - (sumx * sumy)) / denom
        b = (sumy - (m * sumx)) / npts
        result = (m * log10(25)) + b
    else:
        result = avg(ys)
else:
    result = avg_series('MC_LL_PERCENT')</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_ll_nb_ll'), ref('appointment_products.crit_ll_moisture_ll')])]"/>
    </record>

    <!-- Separate Plastic Limit template (ASTM D4318) -->
    <record id="template_pl_d4318" model="lab.test.template">
      <field name="name">فحص حد اللدونة (ASTM D4318)</field>
      <field name="code">PL_D4318</field>
      <field name="industry_type">soil</field>
      <field name="state">active</field>
      <field name="sequence">69</field>
      <field name="applicable_sample_type_ids" eval="[(6,0,[ref('appointment_products.agg_quality_sample_type')])]"/>
    </record>

    <record id="crit_pl_w1_pl" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">وزن العلبة مع العينة الرطبة (غم) - PL</field>
      <field name="code">W1_PL</field>
      <field name="test_type">numeric</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">30</field>
    </record>
    <record id="crit_pl_w2_pl" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">وزن العلبة مع العينة الجافة (غم) - PL</field>
      <field name="code">W2_PL</field>
      <field name="test_type">numeric</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">31</field>
    </record>
    <record id="crit_pl_w3_pl" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">وزن العلبة (غم) - PL</field>
      <field name="code">W3_PL</field>
      <field name="test_type">numeric</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">32</field>
    </record>
    <record id="crit_pl_w4_pl" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">وزن الماء (غم) - PL</field>
      <field name="code">W4_PL</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">33</field>
      <field name="computation_formula">result = (W1_PL or 0) - (W2_PL or 0)</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_pl_w1_pl'), ref('appointment_products.crit_pl_w2_pl')])]"/>
    </record>
    <record id="crit_pl_w5_pl" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">وزن العينة الجافة (غم) - PL</field>
      <field name="code">W5_PL</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_gram_ap"/>
      <field name="sequence">34</field>
      <field name="computation_formula">result = (W2_PL or 0) - (W3_PL or 0)</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_pl_w2_pl'), ref('appointment_products.crit_pl_w3_pl')])]"/>
    </record>
    <record id="crit_pl_moisture_pl" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">المحتوى الرطوبي لكل تجربة PL (%)</field>
      <field name="code">MC_PL_PERCENT</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_percent_ap"/>
      <field name="sequence">35</field>
      <field name="computation_formula">result = (((W4_PL or 0) / (W5_PL or 1)) * 100) if W5_PL else 0</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_pl_w4_pl'), ref('appointment_products.crit_pl_w5_pl')])]"/>
    </record>
    <record id="crit_pl_summary_pl" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">حد اللدونة PL (%)</field>
      <field name="code">PL_PERCENT</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_percent_ap"/>
      <field name="sequence">40</field>
      <field name="is_global">True</field>
      <field name="is_summary_field">True</field>
      <field name="is_required">True</field>
      <field name="computation_formula">result = avg_series('MC_PL_PERCENT')</field>
      <field name="depends_on_criteria_ids" eval="[(6,0,[ref('appointment_products.crit_pl_moisture_pl')])]"/>
    </record>

    <record id="crit_plasticity_index" model="lab.test.criterion">
      <field name="template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="name">دليل اللدونة P.I (%)</field>
      <field name="code">PI_PERCENT</field>
      <field name="test_type">computed</field>
      <field name="is_computed_field">True</field>
      <field name="uom_id" ref="appointment_products.uom_percent_ap"/>
      <field name="sequence">41</field>
      <field name="is_global">True</field>
      <field name="is_summary_field">True</field>
      <field name="is_required">True</field>
      <field name="computation_formula">ll = get_criterion_from_sample_tests('LL_PERCENT') or 0
pl = avg_series('MC_PL_PERCENT') or 0
result = max(0, (ll - pl))</field>
    </record>

    <!-- Link separated LL & PL to Aggregate Quality + Proctor flow (3 samples each) -->
    <record id="flow_stage_ll_d4318_separate" model="lab.test.flow.template.line">
      <field name="template_id" ref="appointment_products.flow_template_agg_quality_with_proctor"/>
      <field name="sequence">30</field>
      <field name="test_template_id" ref="appointment_products.template_ll_d4318"/>
      <field name="sample_qty">3</field>
    </record>
    <record id="flow_stage_pl_d4318_separate" model="lab.test.flow.template.line">
      <field name="template_id" ref="appointment_products.flow_template_agg_quality_with_proctor"/>
      <field name="sequence">31</field>
      <field name="test_template_id" ref="appointment_products.template_pl_d4318"/>
      <field name="sample_qty">3</field>
    </record>
  </data>
</odoo>
