<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">

        <record id="plr_sample_type" model="lab.sample.type">
            <field name="name">فحص انتظام التبليط</field>
            <field name="code">PLR</field>
            <field name="description">فحص الاستوائية الطولية (الانتظام) لكل 300 م، مع تحديد حدود المطابقة بناء على نوع الطبقة في المهمة.</field>
            <field name="sequence">70</field>
            <field name="active">True</field>
        </record>
        
        <record id="template_plr_test" model="lab.test.template">
            <field name="name">فحص انتظام التبليط (الاستوائية)</field>
            <field name="code">PAVEMENT_LONG_REG</field>
            <field name="description">قياس عدد الانحرافات الطولية ضمن فئات: 4.0–5.9 مم، 6.0–10 مم، أكبر من 10 مم لكل مقطع (300 م). المعايير المسموح بها وفق الطبقة.</field>
            <field name="standard_code">Table R9/7</field>
            <field name="industry_type">asphalt</field>
            <field name="state">active</field>
            <field name="sequence">70</field>
            <field name="applicable_sample_type_ids" eval="[(6,0,[ref('plr_sample_type')])]"/>
        </record>

        <record id="crit_plr_4_59" model="lab.test.criterion">
            <field name="template_id" ref="template_plr_test"/>
            <field name="name">عدد الانحرافات 4.0–5.9 مم</field>
            <field name="code">PLR_4_59</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom.product_uom_unit"/>
            <field name="sequence">10</field>
            <field name="is_required">False</field>
        </record>

        <record id="crit_plr_6_10" model="lab.test.criterion">
            <field name="template_id" ref="template_plr_test"/>
            <field name="name">عدد الانحرافات 6.0–10.0 مم</field>
            <field name="code">PLR_6_10</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom.product_uom_unit"/>
            <field name="sequence">20</field>
            <field name="is_required">False</field>
        </record>

        <record id="crit_plr_gt10" model="lab.test.criterion">
            <field name="template_id" ref="template_plr_test"/>
            <field name="name">عدد الانحرافات &gt; 10 مم</field>
            <field name="code">PLR_GT10</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom.product_uom_unit"/>
            <field name="sequence">30</field>
            <field name="is_required">False</field>
        </record>

        <record id="crit_plr_seg_ratio" model="lab.test.criterion">
            <field name="template_id" ref="template_plr_test"/>
            <field name="name">معامل طول المقطع (0..1)</field>
            <field name="code">PLR_SEG_RATIO</field>
            <field name="test_type">numeric</field>
            <field name="uom_id" ref="uom.product_uom_unit"/>
            <field name="sequence">32</field>
            <field name="is_input_field">True</field>
            <field name="is_required">False</field>
        </record>

        <record id="crit_plr_seg_pass" model="lab.test.criterion">
            <field name="template_id" ref="template_plr_test"/>
            <field name="name">مطابقة المقطع (1=مطابق, 0=غير مطابق)</field>
            <field name="code">PLR_SEG_PASS</field>
            <field name="test_type">computed</field>
            <field name="uom_id" ref="uom.product_uom_unit"/>
            <field name="is_input_field">False</field>
            <field name="is_computed_field">True</field>
            <field name="sequence">40</field>
            <field name="depends_on_criteria_ids" eval="[(6,0,[ref('crit_plr_4_59'), ref('crit_plr_6_10'), ref('crit_plr_gt10'), ref('crit_plr_seg_ratio')])]"/>
            <field name="computation_formula"><![CDATA[
# Determine the course type from the sample task
ratio = PLR_SEG_RATIO if PLR_SEG_RATIO is not None else 1.0
ctype = (get_plr_course_type() or 'surface').lower()
is_surface = 1 if ctype == 'surface' else 0

# Full limits for a 300m segment
base_459 = 20 if is_surface else 40
# X means (allowed limit = 0)
base_610 = 0 if is_surface else 3
base_gt10 = 0  # For all types, >10 mm is not allowed

#Application of the length factor
allowed_459 = base_459 * (ratio or 1.0)
allowed_610 = base_610 * (ratio or 1.0)
allowed_gt10 = base_gt10 * (ratio or 1.0)  # Remains zero

exceed = 0
if PLR_4_59 and PLR_4_59 > allowed_459:
    exceed = 1
if not exceed and PLR_6_10 and PLR_6_10 > allowed_610:
    exceed = 1
if not exceed and PLR_GT10 and PLR_GT10 > allowed_gt10:
    exceed = 1

result = 0 if exceed else 1
]]></field>
        </record>

        <record id="crit_plr_nonconf_count" model="lab.test.criterion">
            <field name="template_id" ref="template_plr_test"/>
            <field name="name">عدد المقاطع غير المطابقة</field>
            <field name="code">PLR_NONCONF_COUNT</field>
            <field name="test_type">computed</field>
            <field name="uom_id" ref="uom.product_uom_unit"/>
            <field name="is_input_field">False</field>
            <field name="is_computed_field">True</field>
            <field name="is_summary_field">True</field>
            <field name="sequence">100</field>
            <field name="computation_formula"><![CDATA[
result = count_if_series('PLR_SEG_PASS', '==', 0)
]]></field>
        </record>
        
        <record id="product_plr_sample" model="product.template">
            <field name="name">العينة - انتظام التبليط</field>
            <field name="type">consu</field>
            <field name="is_sample_product">True</field>
            <field name="tracking">serial</field>
            <field name="sample_type_id" ref="plr_sample_type"/>
            <field name="lab_test_template_id" eval="[(6,0,[ref('template_plr_test')])]"/>
            <field name="test_template_ids" eval="[(6,0,[ref('template_plr_test')])]"/>
            <field name="categ_id" ref="product.product_category_all"/>
        </record>
    </data>
</odoo>
