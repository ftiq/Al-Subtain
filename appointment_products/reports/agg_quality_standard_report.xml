<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="agg_quality_standard_report">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="sample">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <style>
                            * { font-family: Arial, sans-serif !important; }
                            .section-title { background:#eef3ff;border:1px solid #cdd9ff;border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;font-size:22px;font-weight:700; }
                            .greeting { text-align: right; margin: 16px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #17a2b8; font-size: 16px; line-height: 1.7; }
                            .table { width:100%; border-collapse:collapse; margin: 0; }
                            .table th { background:#DDDDDD; font-weight:bold; text-align:center; padding:6px 5px; border:1px solid #dee2e6; font-size:12px; }
                            .table thead th, .table tr th { text-align:center !important; vertical-align:middle; }
                            .table td { text-align:center; padding:5px 5px; border:1px solid #dee2e6; font-size:12px; }
                            .lab-section { margin: 6px 0; }
                            .lab-code-badge { display:inline-block;padding:2px 6px;border:1px solid #ddd;border-radius:6px;background:#f8f9fa; }
                            .note-block { padding: 8px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8; }
                        </style>

                        <div class="section-title">
                        م/ تقرير فحص حصى خابط
                        </div>

                        <div class="greeting">
                            <p style="margin: 0;">تحية طيبة ..</p>
                            <p style="margin: 0;">ندرج نتائج الفحص وفق التفاصيل أدناه. راجين الاطلاع ...مع التقدير</p>
                        </div>

                        <t t-set="task" t-value="sample.task_id or False"/>
                        <t t-set="sieve_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.template_id and rs.template_id.code and rs.template_id.code.upper() == 'AGG_QUALITY_SIEVE')"/>
                        <t t-set="proctor_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.template_id and rs.template_id.code and rs.template_id.code.upper() == 'AGG_PROCTOR_D698')"/>
                        <t t-set="cbr_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.template_id and rs.template_id.code and rs.template_id.code.upper() == 'AGG_CBR_D1883')"/>
                        <t t-set="ll_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.template_id and rs.template_id.code and rs.template_id.code.upper() == 'LL_D4318')"/>
                        <t t-set="pl_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.template_id and rs.template_id.code and rs.template_id.code.upper() == 'PL_D4318')"/>

                        <t t-set="sieve_rs" t-value="(sieve_sets and sieve_sets[0]) or False"/>
                        <t t-set="proctor_rs" t-value="(proctor_sets and proctor_sets[0]) or False"/>
                        <t t-set="cbr_rs" t-value="(cbr_sets and cbr_sets[0]) or False"/>
                        <t t-set="ll_rs" t-value="(ll_sets and ll_sets[0]) or False"/>
                        <t t-set="pl_rs" t-value="(pl_sets and pl_sets[0]) or False"/>

                        <div class="lab-section">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>رقم الكتاب</th>
                                        <th>تاريخ الكتاب</th>
                                        <th>رقم الطلب</th>
                                        <th>تاريخ الطلب</th>
                                        <th>تاريخ الاستلام</th>
                                        <th>عدد المجموعات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td t-esc="task.book_number if task and task.book_number else ''"/>
                                        <td t-esc="task.book_date.strftime('%Y-%m-%d') if task and task.book_date else ''"/>
                                        <td t-esc="sample.sale_order_id.name if sample.sale_order_id else ''"/>
                                        <td t-esc="sample.sale_order_id.date_order.strftime('%Y-%m-%d') if sample.sale_order_id and sample.sale_order_id.date_order else ''"/>
                                        <td t-esc="sample.create_date.strftime('%Y-%m-%d') if sample.create_date else ''"/>
                                        <td t-esc="(sieve_sets and len(sieve_sets)) or 0"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <t t-if="sieve_rs">
                            <div class="lab-section" style="margin-top:4px;">
                                <table class="table table-bordered" style="table-layout:fixed;">
                                    <colgroup>
                                        <col style="width:25%;"/>
                                        <col style="width:25%;"/>
                                        <col style="width:25%;"/>
                                        <col style="width:25%;"/>
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th>مقاس المنخل</th>
                                            <th>% المار الفعلي</th>
                                            <th>الحد الأدنى</th>
                                            <th>الحد الأعلى</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="sieve_rs.agg_quality_range_ids.sorted('sequence')" t-as="r">
                                            <tr>
                                                <td t-esc="r.sieve_label or ''"/>
                                                <td><t t-esc="'%.0f' % (r.actual_passing or 0.0)"/></td>
                                                <td><t t-esc="'%.0f' % (r.effective_min or 0.0)"/></td>
                                                <td><t t-esc="'%.0f' % (r.effective_max or 0.0)"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </t>

                        <t t-set="mdd" t-value="(proctor_rs and proctor_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'MDD_KG_M3') and proctor_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'MDD_KG_M3')[0].value_numeric) or 0.0"/>
                        <t t-set="omc" t-value="(proctor_rs and proctor_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'OMC_PERCENT') and proctor_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'OMC_PERCENT')[0].value_numeric) or 0.0"/>
                        <t t-set="cbr95" t-value="(cbr_rs and cbr_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'CBR_AT_95_PERCENT_COMPACTION') and cbr_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'CBR_AT_95_PERCENT_COMPACTION')[0].value_numeric) or 0.0"/>
                        <t t-set="ll_val" t-value="(ll_rs and ll_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'LL_PERCENT') and ll_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'LL_PERCENT')[0].value_numeric) or 0.0"/>
                        <t t-set="pl_val" t-value="(pl_rs and pl_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'PL_PERCENT') and pl_rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'PL_PERCENT')[0].value_numeric) or 0.0"/>
                        <t t-set="pi_val" t-value="(ll_val - pl_val) if (ll_val and pl_val) else 0.0"/>
                        <t t-set="selected_class" t-value="(sieve_rs and sieve_rs.agg_selected_class) or ''"/>
                        <t t-set="cbr_min" t-value="(selected_class == 'B' and 35) or (selected_class == 'C' and 30) or (selected_class == 'D' and 20) or False"/>

                        <div class="lab-section" style="margin-top:6px;">
                            <table class="table table-bordered" style="width:100%;">
                                <tbody>
                                    <tr>
                                        <td style="background-color:#DDDDDD; font-weight:bold; width:25%;">فئة المطابقة</td>
                                        <td><t t-esc="selected_class or '-'"/></td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#DDDDDD; font-weight:bold;">الكثافة الجافة العظمى gm/cm³</td>
                                        <td>
                                            <t t-if="mdd and mdd &gt; 0">
                                                <t t-esc="'%.3f' % (mdd/1000.0)"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#DDDDDD; font-weight:bold;">نسبة الرطوبة المثلى %</td>
                                        <td><t t-esc="'%.1f' % omc if omc else '-'"/></td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#DDDDDD; font-weight:bold;">نسبة التحمل الكاليفورني نسبة الحدل 95% %CBR</td>
                                        <td>
                                            <t t-esc="'%.0f' % cbr95 if cbr95 else '-'"/>
                                            <t t-if="cbr_min"><span class="badge" style="background:#6c757d;color:#fff;margin-right:6px;">حد أدنى <t t-esc="cbr_min"/>%</span></t>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#DDDDDD; font-weight:bold;">LL %</td>
                                        <td><t t-esc="'%.0f' % ll_val if ll_val else '-'"/></td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#DDDDDD; font-weight:bold;">P.I %</td>
                                        <td><t t-esc="'%.0f' % pi_val if pi_val else '-'"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="lab-section" style="page-break-inside: avoid; margin-top: 16px;">
                            <table style="width:100%;border-collapse:collapse;direction:rtl;">
                                <tr>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الوحدة</div>
                                        <t t-if="sample.exec_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.exec_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.exec_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الجودة</div>
                                        <t t-if="sample.super_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.super_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.super_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">المدير التنفيذي</div>
                                        <t t-if="sample.company_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.company_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.company_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>
