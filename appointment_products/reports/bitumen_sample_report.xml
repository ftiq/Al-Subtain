<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- قالب تقرير القير المباشر -->
    <template id="bitumen_report_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="sample">
                <t t-call="web.external_layout">
                    <t t-call="appointment_products.bitumen_report_page" t-lang="sample.env.context.get('lang', 'ar_001')"/>
                </t>
            </t>
        </t>
    </template>

    <template id="bitumen_report_page">
        <div class="page">
            <div class="oe_structure"></div>
            <style>
                @font-face {
                    font-family: 'tradbdo';
                    src: url('/appointment_products/static/src/fonts/tradbdo.ttf') format('truetype');
                    font-weight: bold;
                    font-style: normal;
                }
                
                .custom-main-title {
                    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                    color: #000 !important;
                    padding: 15px;
                    margin: 8px 0 15px 0;
                    border-radius: 12px;
                    text-align: center;
                    font-family: 'tradbdo', Arial, sans-serif !important;
                    font-size: 22px !important;
                    font-weight: 600;
                    box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
                    border: 2px solid #1e3c72;
                    position: relative;
                    overflow: hidden;
                }
                
                .custom-main-title::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                    animation: shine 3s infinite;
                }
                
                @keyframes shine {
                    0% { left: -100%; }
                    50% { left: 100%; }
                    100% { left: 100%; }
                }
                
                h1, h2, h3, h4, h5, h6 {
                    font-family: 'tradbdo', Arial, sans-serif !important;
                }
                
                table th {
                    font-family: 'tradbdo', Arial, sans-serif !important;
                }
                
                .lab-section {
                    background: #fff;
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    margin: 4px 0;
                    padding: 8px;
                }
                
                .lab-section h3 {
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: #000 !important;
                    padding: 6px 8px;
                    margin: -8px -8px 8px -8px;
                    border-radius: 10px 10px 0 0;
                    font-weight: 600;
                    font-size: 16px !important;
                    text-align: center;
                    font-family: 'tradbdo', Arial, sans-serif !important;
                    border-bottom: 2px solid #28a745;
                    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.25);
                    position: relative;
                }
                
                .lab-section h3::after {
                    content: '';
                    position: absolute;
                    bottom: -2px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 50px;
                    height: 3px;
                    background: #fff;
                    border-radius: 2px;
                }
                
                .lab-section table {
                    width: 100%;
                    border-collapse: collapse;
                    background: #fff;
                }
                
                .lab-section table thead th {
                    background: rgba(13, 110, 253, 0.1);
                    color: #0d6efd;
                    font-weight: 600;
                    padding: 8px 6px;
                    text-align: center;
                    border: 1px solid #dee2e6;
                    font-size: 14px;
                    font-family: 'tradbdo', Arial, sans-serif !important;
                }
                
                .lab-section table tbody td {
                    padding: 6px 4px;
                    border: 1px solid #dee2e6;
                    text-align: center;
                    font-size: 13px;
                }
                
                .page {
                    background: #fff;
                    padding: 20px;
                    font-size: 15px;
                }
                
                @media print {
                    .lab-section table thead {
                        display: table-header-group !important;
                    }
                    
                    .lab-section table tbody {
                        display: table-row-group;
                    }
                    
                    .lab-section table {
                        page-break-inside: auto;
                        border-collapse: collapse;
                    }
                    
                    .lab-section table tr {
                        page-break-inside: avoid;
                        page-break-after: auto;
                    }
                    
                    .lab-section {
                        page-break-inside: avoid;
                    }
                    
                    .lab-section h3 {
                        page-break-after: avoid !important;
                        page-break-inside: avoid !important;
                        margin-bottom: 0 !important;
                    }
                    
                    .lab-section h3 + * {
                        page-break-before: avoid !important;
                    }
                }
                
                .summary-card {
                    background: linear-gradient(to bottom, #fff 0%, #f8f9ff 100%);
                    border: none;
                    border-radius: 16px;
                    box-shadow: 0 8px 25px rgba(13, 110, 253, 0.15);
                    margin: 8px 0;
                    padding: 12px;
                }
                
                .summary-card h3 {
                    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
                    color: #000 !important;
                    padding: 10px 12px;
                    margin: -12px -12px 12px -12px;
                    border-radius: 15px 15px 0 0;
                    font-weight: 700;
                    font-size: 18px !important;
                    text-align: center;
                    box-shadow: 0 3px 15px rgba(255, 107, 53, 0.4);
                    font-family: 'tradbdo', Arial, sans-serif !important;
                    border: 2px solid #ff6b35;
                    position: relative;
                }
            </style>
            
            <!-- العنوان الرئيسي -->
            <div class="custom-main-title">
                <span t-if="sample.bitumen_type == 'قير أساس'">م/ تقرير ( فحوصات قير الأساس )</span>
                <span t-elif="sample.bitumen_type == 'قير تسطيح'">م/ تقرير ( فحوصات قير التسطيح )</span>
                <span t-else="">م/ تقرير ( فحوصات القير الإسفلتي )</span>
            </div>
            
            <div style="text-align: right; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #17a2b8; font-family: 'tradbdo', Arial, sans-serif; font-size: 16px; line-height: 1.8;">
                <p style="margin: 0;">تحية طيبة ..</p>
                <p style="margin: 0;">ندرج نتائج فحص النماذج المبينة تفاصيلها ادناه. راجين الاطلاع ...مع التقدير</p>
            </div>
            
            <!-- البيانات الأولية -->
            <t t-set="task" t-value="sample.task_id or env['project.task'].search([('stock_receipt_id.move_line_ids.product_id', '=', sample.product_id.id)], limit=1)"/>
            <t t-set="result_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.template_id and rs.template_id.industry_type == 'asphalt')"/>
            <t t-set="total_samples_count" t-value="len(result_sets)"/>
            
            <div class="lab-section">
                <table class="table table-bordered">
                    <thead>
                        <tr style="background-color: #DDDDDD;">
                            <th style="text-align: center; padding: 8px; font-weight: bold; font-family: 'tradbdo', Arial, sans-serif; color: black; background-color: #DDDDDD; font-size: 16px;">رقم الكتاب</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold; font-family: 'tradbdo', Arial, sans-serif; color: black; background-color: #DDDDDD; font-size: 16px;">تاريخ الكتاب</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold; font-family: 'tradbdo', Arial, sans-serif; color: black; background-color: #DDDDDD; font-size: 16px;">رقم الطلب</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold; font-family: 'tradbdo', Arial, sans-serif; color: black; background-color: #DDDDDD; font-size: 16px;">تاريخ الطلب</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold; font-family: 'tradbdo', Arial, sans-serif; color: black; background-color: #DDDDDD; font-size: 16px;">تاريخ الاستلام</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold; font-family: 'tradbdo', Arial, sans-serif; color: black; background-color: #DDDDDD; font-size: 16px;">عدد النماذج</th>
                            <th style="text-align: center; padding: 8px; font-weight: bold; font-family: 'tradbdo', Arial, sans-serif; color: black; background-color: #DDDDDD; font-size: 16px;">موقع النموذج</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="task.book_number if task and task.book_number else ''"/>
                            <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="task.book_date.strftime('%Y-%m-%d') if task and task.book_date else ''"/>
                            <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="sample.sale_order_id.name if sample.sale_order_id else ''"/>
                            <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="sample.sale_order_id.date_order.strftime('%Y-%m-%d') if sample.sale_order_id and sample.sale_order_id.date_order else ''"/>
                            <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="sample.create_date.strftime('%Y-%m-%d') if sample.create_date else ''"/>
                            <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="total_samples_count"/>
                            <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- محتوى ملخص نتائج القير -->
            <div class="lab-section">
                <h3>نتائج فحوصات القير</h3>
                
                <!-- عرض نتائج القير مع المستويات كنص -->
                <t t-if="result_sets">
                    <t t-foreach="result_sets" t-as="result_set">
                        <t t-if="result_set.template_id">
                            <div class="summary-card" style="margin: 10px 0;">
                                <h4 style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: #000; padding: 8px; margin: -12px -12px 10px -12px; border-radius: 15px 15px 0 0; text-align: center; font-size: 16px;">
                                    <t t-esc="result_set.template_id.name"/>
                                </h4>
                                
                                <table class="table table-bordered" style="margin-bottom: 15px;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="text-align: center; padding: 8px; border: 1px solid #dee2e6; font-size: 16px;">المعيار</th>
                                            <th style="text-align: center; padding: 8px; border: 1px solid #dee2e6; font-size: 16px;">القيمة</th>
                                            <th style="text-align: center; padding: 8px; border: 1px solid #dee2e6; font-size: 16px;">الوحدة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="result_set.result_line_ids.filtered(lambda x: x.criterion_id and 'نتيجة فحص الليونة' not in x.criterion_id.name)" t-as="line">
                                            <tr>
                                                <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6; font-size: 13px;">
                                                    <t t-esc="line.criterion_id.name"/>
                                                </td>
                                                <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6; font-size: 13px;">
                                                    <t t-if="line.criterion_id and line.criterion_id.test_type in ('numeric','computed')">
                                                        <t t-esc="line.value_numeric if line.value_numeric not in (None, False) else '-'"/>
                                                    </t>
                                                    <t t-else="">
                                                        <t t-esc="line.value_text or line.result_value or '-'"/>
                                                    </t>
                                                </td>
                                                <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6; font-size: 13px;">
                                                    <t t-esc="line.criterion_id.uom_id.name if line.criterion_id.uom_id else ''"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                                
                                <!-- إضافة المستوى كنص تحت كل جدول -->
                                <t t-if="result_set.template_id.name and 'اختراق' in result_set.template_id.name">
                                    <t t-set="penetration_line" t-value="result_set.result_line_ids.filtered(lambda x: x.criterion_id and 'اختراق' in x.criterion_id.name)"/>
                                    <t t-if="penetration_line and penetration_line[0].value_numeric not in (None, False)">
                                        <t t-set="pen_value" t-value="penetration_line[0].value_numeric"/>
                                        <div style="margin: 10px 0; padding: 8px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
                                            <strong>المستوى المطبق: </strong>
                                            <t t-if="sample.bitumen_type == 'قير تسطيح'">
                                                <span t-if="200 &lt;= pen_value &lt;= 300">النوع الأول (200-300)</span>
                                                <span t-elif="100 &lt;= pen_value &lt;= 200">النوع الثاني (100-200)</span>
                                                <span t-elif="50 &lt;= pen_value &lt;= 100">النوع الثالث (50-100)</span>
                                                <span t-elif="25 &lt;= pen_value &lt;= 50">النوع الرابع (25-50)</span>
                                                <span t-else="">خارج المواصفات</span>
                                            </t>
                                            <t t-elif="sample.bitumen_type == 'قير أساس'">
                                                <span t-if="50 &lt;= pen_value &lt;= 100">المستوى الأول (50-100)</span>
                                                <span t-elif="25 &lt;= pen_value &lt;= 50">المستوى الثاني (25-50)</span>
                                                <span t-elif="20 &lt;= pen_value &lt;= 40">المستوى الثالث (20-40)</span>
                                                <span t-else="">خارج المواصفات</span>
                                            </t>
                                        </div>
                                    </t>
                                </t>
                                
                                <t t-if="result_set.template_id.name and 'استطالة' in result_set.template_id.name">
                                    <t t-set="ductility_line" t-value="result_set.result_line_ids.filtered(lambda x: x.criterion_id and 'استطالة' in x.criterion_id.name)"/>
                                    <t t-if="ductility_line and ductility_line[0].value_numeric not in (None, False)">
                                        <t t-set="duct_value" t-value="ductility_line[0].value_numeric"/>
                                        <div style="margin: 10px 0; padding: 8px; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #4caf50;">
                                            <strong>المستوى المطبق: </strong>
                                            <t t-if="sample.bitumen_type == 'قير تسطيح'">
                                                <span t-if="duct_value >= 10">النوع الأول (≥ 10 سم)</span>
                                                <span t-elif="duct_value >= 3">النوع الثاني (≥ 3 سم)</span>
                                                <span t-elif="duct_value >= 2.5">النوع الثالث (≥ 2.5 سم)</span>
                                                <span t-elif="duct_value >= 1.5">النوع الرابع (≥ 1.5 سم)</span>
                                                <span t-else="">خارج المواصفات</span>
                                            </t>
                                            <t t-elif="sample.bitumen_type == 'قير أساس'">
                                                <span t-if="duct_value >= 3">المستوى الأول (≥ 3 سم)</span>
                                                <span t-elif="duct_value >= 2.5">المستوى الثاني (≥ 2.5 سم)</span>
                                                <span t-elif="duct_value >= 2">المستوى الثالث (≥ 2 سم)</span>
                                                <span t-else="">خارج المواصفات</span>
                                            </t>
                                        </div>
                                    </t>
                                </t>
                                
                                <t t-if="result_set.template_id.name and ('تليين' in result_set.template_id.name or 'نعومة' in result_set.template_id.name or 'ليونة' in result_set.template_id.name)">
                                    <t t-set="softening_line" t-value="result_set.result_line_ids.filtered(lambda x: x.criterion_id and ('تليين' in x.criterion_id.name or 'نعومة' in x.criterion_id.name or 'ليونة' in x.criterion_id.name) and 'نتيجة' not in x.criterion_id.name)"/>
                                    <t t-if="softening_line and softening_line[0].value_numeric not in (None, False)">
                                        <t t-set="soft_value" t-value="softening_line[0].value_numeric"/>
                                        <div style="margin: 10px 0; padding: 8px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                                            <strong>المستوى المطبق: </strong>
                                            <t t-if="sample.bitumen_type == 'قير تسطيح'">
                                                <span t-if="35 &lt;= soft_value &lt;= 43">النوع الأول (35-43°م)</span>
                                                <span t-elif="43 &lt;= soft_value &lt;= 51">النوع الثاني (43-51°م)</span>
                                                <span t-elif="51 &lt;= soft_value &lt;= 58">النوع الثالث (51-58°م)</span>
                                                <span t-elif="58 &lt;= soft_value &lt;= 65">النوع الرابع (58-65°م)</span>
                                                <span t-else="">خارج المواصفات</span>
                                            </t>
                                            <t t-elif="sample.bitumen_type == 'قير أساس'">
                                                <span t-if="51 &lt;= soft_value &lt;= 58">المستوى الأول (51-58°م)</span>
                                                <span t-elif="58 &lt;= soft_value &lt;= 65">المستوى الثاني (58-65°م)</span>
                                                <span t-elif="60 &lt;= soft_value &lt;= 70">المستوى الثالث (60-70°م)</span>
                                                <span t-else="">خارج المواصفات</span>
                                            </t>
                                        </div>
                                    </t>
                                </t>
                                
                                <t t-if="result_set.template_id.name and ('وميض' in result_set.template_id.name or 'اشتعال' in result_set.template_id.name)">
                                    <t t-set="flash_line" t-value="result_set.result_line_ids.filtered(lambda x: x.criterion_id and ('وميض' in x.criterion_id.name or 'اشتعال' in x.criterion_id.name))"/>
                                    <t t-if="flash_line and flash_line[0].value_numeric not in (None, False)">
                                        <t t-set="flash_value" t-value="flash_line[0].value_numeric"/>
                                        <div style="margin: 10px 0; padding: 8px; background: #ffebee; border-radius: 5px; border-left: 4px solid #f44336;">
                                            <strong>المستوى المطبق: </strong>
                                            <span t-if="flash_value >= 302">مطابق للمواصفات (≥ 302°م)</span>
                                            <span t-else="">خارج المواصفات (&lt; 302°م)</span>
                                        </div>
                                    </t>
                                </t>
                            </div>
                        </t>
                    </t>
                </t>
                <t t-else="">
                    <p>لا توجد نتائج فحص متاحة للعرض</p>
                </t>
            </div>

            <!-- الملاحظات -->
            <t t-if="sample.notes">
                <div class="lab-section" style="page-break-inside: avoid;">
                    <h3>الملاحظات</h3>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <div style="font-size: 14px; line-height: 1.6; font-family: 'tradbdo', Arial, sans-serif;" t-field="sample.notes"/>
                    </div>
                </div>
            </t>

            <!-- التوقيعات -->
            <div class="lab-section" style="page-break-inside: avoid; margin-top: 20px;">
                <h3>التوقيعات</h3>
                <div style="padding-bottom:4px;margin-bottom:4px;">
                    <table style="width:100%;border-collapse:collapse;direction:rtl;">
                        <tr>
                            <td style="width:33.33%;text-align:center;padding:15px;border:1px solid #c0d6e4;border-radius:8px;background:#ffffff;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                <div style="margin-bottom:8px;">
                                    <strong>مسؤول الوحدة</strong>
                                </div>
                                <t t-if="sample.exec_signature">
                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;display:flex;align-items:center;justify-content:center;">
                                        <img t-att-src="image_data_uri(sample.exec_signature)" style="max-width:100%;max-height:100%;"/>
                                    </div>
                                    <div style="font-size:12px;"><t t-esc="sample.exec_signer_name or ''"/></div>
                                </t>
                                <t t-else="">
                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;"/>
                                    <div style="font-size:12px;">الاسم/ ____________</div>
                                </t>
                            </td>
                            <td style="width:10px;"></td>
                            <td style="width:33.33%;text-align:center;padding:15px;border:1px solid #c0d6e4;border-radius:8px;background:#ffffff;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                <div style="margin-bottom:8px;">
                                    <strong>مسؤول الجودة</strong>
                                </div>
                                <t t-if="sample.super_signature">
                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;display:flex;align-items:center;justify-content:center;">
                                        <img t-att-src="image_data_uri(sample.super_signature)" style="max-width:100%;max-height:100%;"/>
                                    </div>
                                    <div style="font-size:12px;"><t t-esc="sample.super_signer_name or ''"/></div>
                                </t>
                                <t t-else="">
                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;"/>
                                    <div style="font-size:12px;">الاسم/ ____________</div>
                                </t>
                            </td>
                            <td style="width:10px;"></td>
                            <td style="width:33.33%;text-align:center;padding:15px;border:1px solid #c0d6e4;border-radius:8px;background:#ffffff;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                <div style="margin-bottom:8px;">
                                    <strong>المدير التنفيذي</strong>
                                </div>
                                <t t-if="sample.company_signature">
                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;display:flex;align-items:center;justify-content:center;">
                                        <img t-att-src="image_data_uri(sample.company_signature)" style="max-width:100%;max-height:100%;"/>
                                    </div>
                                    <div style="font-size:12px;"><t t-esc="sample.company_signer_name or ''"/></div>
                                </t>
                                <t t-else="">
                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;"/>
                                    <div style="font-size:12px;">الاسم/ ____________</div>
                                </t>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
        </div>
    </template>
</odoo>
