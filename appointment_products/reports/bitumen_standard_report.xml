<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Standardized Bitumen Test Report (QWeb PDF) -->


    <template id="bitumen_standard_report">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="sample">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <style>
                            * { font-family: Arial, sans-serif !important; }
                            /* Compact style for detailed tables */
                            .compact-table thead th { padding: 6px 4px; font-size: 13px; }
                            .compact-table tbody td { padding: 3px 2px; font-size: 12px; line-height: 1.2; }
                        </style>

                        <div class="custom-main-title" style="background:#eef3ff;border:1px solid #cdd9ff;border-radius:8px;padding:12px;margin-bottom:12px;text-align:center;font-size:24px;font-weight:700;">
                            <span t-if="sample.bitumen_type == 'قير أساس'">تقرير فحوصات قير الأساس</span>
                            <span t-elif="sample.bitumen_type == 'قير تسطيح'">تقرير فحوصات قير التسطيح</span>
                            <span t-else="">تقرير فحوصات القير الإسفلتي</span>
                        </div>

                        <t t-set="product" t-value="sample.product_id or False"/>
                        <t t-set="product_code" t-value="(product.default_code or '') if product else ''"/>
                        <t t-set="product_name" t-value="(product.name or '') if product else ''"/>
                        <t t-set="bt" t-value="sample.bitumen_type or ''"/>
                        <t t-set="is_surface" t-value="('SURFACE' in product_code) or ('تسطيح' in product_name)"/>
                        <t t-set="is_base" t-value="('BASE' in product_code) or ('أساس' in product_name)"/>
                        <t t-set="is_surface_final" t-value="(bt == 'قير تسطيح') or is_surface"/>
                        <t t-set="is_base_final" t-value="(bt == 'قير أساس') or is_base"/>

                        <div style="text-align: right; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #17a2b8; font-size: 20px; line-height: 1.8;">
                            <p style="margin: 0;">تحية طيبة ..</p>
                            <p style="margin: 0;">ندرج نتائج فحص النماذج المبينة تفاصيلها ادناه. راجين الاطلاع ...مع التقدير</p>
                        </div>
                        <t t-set="task" t-value="sample.task_id or env['project.task'].search([('stock_receipt_id.move_line_ids.product_id', '=', sample.product_id.id)], limit=1)"/>
                        <t t-set="result_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.template_id and rs.template_id.industry_type == 'asphalt')"/>
                        <t t-set="total_samples_count" t-value="len(result_sets)"/>

                        <div class="lab-section">
                            <table class="table table-bordered">
                                <thead>
                                    <tr style="background-color: #DDDDDD;">
                                        <th style="text-align: center; padding: 8px; font-weight: bold; color: black; background-color: #DDDDDD; font-size: 16px;">رقم الكتاب</th>
                                        <th style="text-align: center; padding: 8px; font-weight: bold; color: black; background-color: #DDDDDD; font-size: 16px;">تاريخ الكتاب</th>
                                        <th style="text-align: center; padding: 8px; font-weight: bold; color: black; background-color: #DDDDDD; font-size: 16px;">رقم الطلب</th>
                                        <th style="text-align: center; padding: 8px; font-weight: bold; color: black; background-color: #DDDDDD; font-size: 16px;">تاريخ الطلب</th>
                                        <th style="text-align: center; padding: 8px; font-weight: bold; color: black; background-color: #DDDDDD; font-size: 16px;">تاريخ الاستلام</th>
                                        <th style="text-align: center; padding: 8px; font-weight: bold; color: black; background-color: #DDDDDD; font-size: 16px;">عدد النماذج</th>
                                        <th style="text-align: center; padding: 8px; font-weight: bold; color: black; background-color: #DDDDDD; font-size: 16px;">موقع النموذج</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="task.book_number if task and task.book_number else ''"/>
                                        <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="task.book_date.strftime('%Y-%m-%d') if task and task.book_date else ''"/>
                                        <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="sample.sale_order_id.name if sample.sale_order_id else ''"/>
                                        <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="sample.sale_order_id.date_order.strftime('%Y-%m-%d') if sample.sale_order_id and sample.sale_order_id.date_order else ''"/>
                                        <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="sample.create_date.strftime('%Y-%m-%d') if sample.create_date else ''"/>
                                        <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;" t-esc="total_samples_count"/>
                                        <td style="text-align: center; padding: 6px; border: 1px solid #dee2e6;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <t t-set="lines" t-value="sample.result_set_ids.mapped('result_line_ids')"/>
                        <t t-set="softening_line_all" t-value="lines.filtered(lambda x: x.criterion_id and x.criterion_id.code == 'SOFTENING_AVG')"/>
                        <t t-set="softening_line" t-value="softening_line_all and softening_line_all[0] or False"/>
                        <t t-set="duct_line_all" t-value="lines.filtered(lambda x: x.criterion_id and x.criterion_id.code == 'DUCTILITY_TEST_AVG')"/>
                        <t t-set="duct_line" t-value="duct_line_all and duct_line_all[0] or False"/>
                        <t t-set="pen_line_all" t-value="lines.filtered(lambda x: x.criterion_id and x.criterion_id.code == 'PENTEST_AVG')"/>
                        <t t-set="pen_line" t-value="pen_line_all and pen_line_all[0] or False"/>
                        <t t-set="flash_line_all" t-value="lines.filtered(lambda x: x.criterion_id and (x.criterion_id.code in ['FLASH_POINT','FLASH_IGNITION_POINT']))"/>
                        <t t-set="flash_line" t-value="flash_line_all and flash_line_all[0] or False"/>

                        <div class="lab-section" style="margin:8px 0;">
                            <h3 style="text-align:center;background:#eaf7ff;border:1px solid #cbe8fb;border-radius:8px;padding:6px;margin:-6px -6px 8px -6px;">ملخص النتائج</h3>
                            <table class="table table-bordered" style="width:100%;">
                                <thead>
                                    <tr style="background:#f8f9fa;">
                                        <th style="text-align:center;font-size:16px;">الاختبار</th>
                                        <th style="text-align:center;font-size:16px;">المعيار</th>
                                        <th style="text-align:center;font-size:16px;">القيمة</th>
                                        <th style="text-align:center;font-size:16px;">الوحدة</th>
                                        <th style="text-align:center;font-size:16px;">الحد/المستوى</th>
                                        <th style="text-align:center;font-size:16px;">القرار</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Softening -->
                                    <tr>
                                        <td style="text-align:center;">Softening Point (Ring &amp; Ball)</td>
                                        <td style="text-align:center;">ASTM D36/D36M</td>
                                        <td style="text-align:center;">
                                            <t t-if="softening_line and softening_line.value_numeric not in (None, False)">
                                                <t t-esc="'{:.2f}'.format(softening_line.value_numeric)"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </td>
                                        <td style="text-align:center;">°C</td>
                                        <td style="text-align:center;">
                                            <t t-if="softening_line and softening_line.value_numeric not in (None, False)">
                                                <t t-set="sv" t-value="softening_line.value_numeric"/>
                                                <t t-if="is_surface_final">
                                                    <t t-if="57 &lt;= sv &lt;= 66">النوع الأول (57–66)</t>
                                                    <t t-elif="70 &lt;= sv &lt;= 80">النوع الثاني (70–80)</t>
                                                    <t t-elif="85 &lt;= sv &lt;= 96">النوع الثالث (85–96)</t>
                                                    <t t-elif="99 &lt;= sv &lt;= 107">النوع الرابع (99–107)</t>
                                                    <t t-else="">خارج المواصفات</t>
                                                </t>
                                                <t t-elif="is_base_final">
                                                    <t t-if="46 &lt;= sv &lt;= 60">المستوى الأول (46–60)</t>
                                                    <t t-elif="63 &lt;= sv &lt;= 77">المستوى الثاني (63–77)</t>
                                                    <t t-elif="83 &lt;= sv &lt;= 93">المستوى الثالث (83–93)</t>
                                                    <t t-else="">خارج المواصفات</t>
                                                </t>
                                                <t t-else="">—</t>
                                            </t>
                                            <t t-else="">—</t>
                                        </td>
                                        <td style="text-align:center;">
                                            <t t-if="softening_line and softening_line.value_numeric not in (None, False)">
                                                <t t-set="sv" t-value="softening_line.value_numeric"/>
                                                <t t-if="(is_surface_final and ((57 &lt;= sv &lt;= 66) or (70 &lt;= sv &lt;= 80) or (85 &lt;= sv &lt;= 96) or (99 &lt;= sv &lt;= 107))) or (is_base_final and ((46 &lt;= sv &lt;= 60) or (63 &lt;= sv &lt;= 77) or (83 &lt;= sv &lt;= 93)))">مطابق</t>
                                                <t t-else="">غير مطابق</t>
                                            </t>
                                            <t t-else="">—</t>
                                        </td>
                                    </tr>

                                    <!-- Ductility -->
                                    <tr>
                                        <td style="text-align:center;">Ductility</td>
                                        <td style="text-align:center;">ASTM D113/D113M</td>
                                        <td style="text-align:center;">
                                            <t t-if="duct_line and duct_line.value_numeric not in (None, False)">
                                                <t t-esc="'{:.2f}'.format(duct_line.value_numeric)"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </td>
                                        <td style="text-align:center;">سم</td>
                                        <td style="text-align:center;">
                                            <t t-if="duct_line and duct_line.value_numeric not in (None, False)">
                                                <t t-set="dv" t-value="duct_line.value_numeric"/>
                                                <t t-if="is_surface_final">
                                                    <t t-if="dv &gt;= 10">النوع الأول (≥10)</t>
                                                    <t t-elif="dv &gt;= 3">النوع الثاني (≥3)</t>
                                                    <t t-elif="dv &gt;= 2.5">النوع الثالث (≥2.5)</t>
                                                    <t t-elif="dv &gt;= 1.5">النوع الرابع (≥1.5)</t>
                                                    <t t-else="">خارج المواصفات</t>
                                                </t>
                                                <t t-elif="is_base_final">
                                                    <t t-if="dv &gt;= 30">المستوى الأول (≥30)</t>
                                                    <t t-elif="dv &gt;= 10">المستوى الثاني (≥10)</t>
                                                    <t t-elif="dv &gt;= 2">المستوى الثالث (≥2)</t>
                                                    <t t-else="">خارج المواصفات</t>
                                                </t>
                                                <t t-else="">—</t>
                                            </t>
                                            <t t-else="">—</t>
                                        </td>
                                        <td style="text-align:center;">
                                            <t t-if="duct_line and duct_line.value_numeric not in (None, False)">
                                                <t t-set="dv" t-value="duct_line.value_numeric"/>
                                                <t t-if="(is_surface_final and (dv &gt;= 1.5)) or (is_base_final and (dv &gt;= 2))">مطابق</t>
                                                <t t-else="">غير مطابق</t>
                                            </t>
                                            <t t-else="">—</t>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="text-align:center;">Penetration</td>
                                        <td style="text-align:center;">ASTM D5/D5M</td>
                                        <td style="text-align:center;">
                                            <t t-if="pen_line and pen_line.value_numeric not in (None, False)">
                                                <t t-esc="'{:.1f}'.format(pen_line.value_numeric)"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </td>
                                        <td style="text-align:center;">0.1 مم (dmm)</td>
                                        <td style="text-align:center;">
                                            <t t-if="pen_line and pen_line.value_numeric not in (None, False)">
                                                <t t-set="pv" t-value="pen_line.value_numeric"/>
                                                <t t-if="is_surface_final">
                                                    <t t-if="18 &lt;= pv &lt;= 60">النوع الأول (18–60)</t>
                                                    <t t-elif="15 &lt;= pv &lt;= 35">النوع الثاني (15–35)</t>
                                                    <t t-elif="12 &lt;= pv &lt;= 25">النوع الثالث (12–25)</t>
                                                    <t t-else="">خارج المواصفات</t>
                                                </t>
                                                <t t-elif="is_base_final">
                                                    <t t-if="50 &lt;= pv &lt;= 100">المستوى الأول (50–100)</t>
                                                    <t t-elif="25 &lt;= pv &lt;= 50">المستوى الثاني (25–50)</t>
                                                    <t t-elif="20 &lt;= pv &lt;= 40">المستوى الثالث (20–40)</t>
                                                    <t t-else="">خارج المواصفات</t>
                                                </t>
                                                <t t-else="">—</t>
                                            </t>
                                            <t t-else="">—</t>
                                        </td>
                                        <td style="text-align:center;">
                                            <t t-if="pen_line and pen_line.value_numeric not in (None, False)">
                                                <t t-set="pv" t-value="pen_line.value_numeric"/>
                                                <t t-if="(is_surface_final and ((18 &lt;= pv &lt;= 60) or (15 &lt;= pv &lt;= 35) or (12 &lt;= pv &lt;= 25))) or (is_base_final and ((50 &lt;= pv &lt;= 100) or (25 &lt;= pv &lt;= 50) or (20 &lt;= pv &lt;= 40)))"> مطابق</t>
                                                <t t-else=""> غير مطابق</t>
                                            </t>
                                            <t t-else="">—</t>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="text-align:center;">Flash Point (Cleveland Open Cup)</td>
                                        <td style="text-align:center;">ASTM D92</td>
                                        <td style="text-align:center;">
                                            <t t-if="flash_line and flash_line.value_numeric not in (None, False)">
                                                <t t-esc="'{:.2f}'.format(flash_line.value_numeric)"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </td>
                                        <td style="text-align:center;">°C</td>
                                        <td style="text-align:center;">
                                            <t t-if="is_surface_final">الحد الأدنى (≥302)</t>
                                            <t t-elif="is_base_final">الحد الأدنى (≥232)</t>
                                            <t t-else="">—</t>
                                        </td>
                                        <td style="text-align:center;">
                                            <t t-if="flash_line and flash_line.value_numeric not in (None, False)">
                                                <t t-set="fv" t-value="flash_line.value_numeric"/>
                                                <t t-if="(is_surface_final and fv &gt;= 302) or (is_base_final and fv &gt;= 232)">مطابق</t>
                                                <t t-else="">غير مطابق</t>
                                            </t>
                                            <t t-else="">—</t>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>


                        <div class="lab-section" style="margin-top:10px;">
                            <h3 style="text-align:center;background:#f1fff1;border:1px solid #c8f7c8;border-radius:8px;padding:6px;margin:-6px -6px 8px -6px;">الجداول التفصيلية</h3>
                            <t t-if="sample.result_set_ids">
                                <t t-foreach="sample.result_set_ids" t-as="result_set">
                                    <div style="margin:10px 0;">
                                        <h4 style="text-align:center;background:#eef7ff;border:1px solid #cbe1ff;border-radius:6px;padding:4px;">
                                            <t t-esc="result_set.template_id and result_set.template_id.name or 'قالب غير محدد'"/>
                                        </h4>
                                        <table class="table table-bordered compact-table" style="width:100%;">
                                            <thead>
                                                <tr style="background:#f8f9fa;">
                                                    <th style="text-align:center;">المعيار</th>
                                                    <th style="text-align:center;">القيمة</th>
                                                    <th style="text-align:center;">الوحدة</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="result_set.result_line_ids.filtered(lambda x: x.criterion_id and 'نتيجة فحص الليونة' not in x.criterion_id.name)" t-as="line">
                                                    <tr>
                                                        <td style="text-align:center;" t-esc="line.criterion_id.name"/>
                                                        <td style="text-align:center;">
                                                            <t t-if="line.criterion_id and line.criterion_id.test_type in ('numeric','computed')">
                                                                <t t-if="line.value_numeric not in (None, False)">
                                                                    <t t-esc="'{:.2f}'.format(line.value_numeric)"/>
                                                                </t>
                                                                <t t-else="">-</t>
                                                            </t>
                                                            <t t-else="">
                                                                <t t-esc="line.result_value or line.value_text or '-'"/>
                                                            </t>
                                                        </td>
                                                        <td style="text-align:center;" t-esc="line.criterion_id.uom_id and line.criterion_id.uom_id.name or ''"/>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <p style="text-align:center;">لا توجد نتائج فحص متاحة للعرض</p>
                            </t>
                        </div>

                        <!-- Notes -->
                        <t t-if="sample.notes">
                            <div class="lab-section" style="page-break-inside: avoid;">
                                <h3>الملاحظات</h3>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <div style="font-size: 14px; line-height: 1.6;" t-field="sample.notes"/>
                                </div>
                            </div>
                        </t>

                        <!-- Signatures -->
                        <div class="lab-section" style="page-break-inside: avoid; margin-top: 16px;">
                            <table style="width:100%;border-collapse:collapse;direction:rtl;">
                                <tr>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الوحدة</div>
                                        <t t-if="sample.exec_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.exec_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.exec_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الجودة</div>
                                        <t t-if="sample.super_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.super_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.super_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">المدير التنفيذي</div>
                                        <t t-if="sample.company_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.company_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.company_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>

                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>
