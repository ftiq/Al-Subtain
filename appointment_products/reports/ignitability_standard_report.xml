<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="ignitability_standard_report">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="sample">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <style>
                            * { font-family: Arial, sans-serif !important; font-size: 12px; }
                            .section-title { background:#eef3ff;border:1px solid #cdd9ff;border-radius:8px;padding:4px;margin-bottom:4px;text-align:center;font-size:18px;font-weight:700; }
                            .lab-section { margin: 0; }
                            .table { width:100%; border-collapse:collapse; margin: 0; }
                            .table th { background:#DDDDDD; font-weight:bold; text-align:center; padding:4px 3px; border:1px solid #dee2e6; font-size:12px; }
                            .table thead th, .table tr th { text-align:center !important; vertical-align:middle; }
                            .table td { text-align:center; padding:3px 3px; border:1px solid #dee2e6; font-size:12px; }
                            .subhead { background:#f8f9fa; font-weight:bold; padding:2px; font-size:13px; margin: 0; }
                            /* تخصيص عرض عمود الكثافة في جدول وصف المنتج إلى 2 سم، والسماح لعمود الموقع بأخذ المساحة المتبقية */
                            .product-table th:nth-child(3), .product-table td:nth-child(3) { width: 2cm; }
                            .product-table th:nth-child(4), .product-table td:nth-child(4) { width: auto; }
                        </style>

                        <div class="section-title">م/ تقرير قابلية الاشتعال للمنتجات (ISO 11925-2)</div>

                        <div style="text-align: right; margin: 12px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #17a2b8; font-size: 16px; line-height: 1.7;">
                            <p style="margin: 0;">تحية طيبة ..</p>
                            <p style="margin: 0;">ندرج نتائج فحص النماذج المبينة تفاصيلها ادناه. راجين الاطلاع ...مع التقدير</p>
                        </div>

                        <t t-set="task" t-value="sample.task_id or False"/>
                        <t t-set="result_sets" t-value="sample.result_set_ids.filtered(lambda rs: rs.is_ignitability_sample)"/>
                        <t t-set="sorted_sets" t-value="result_sets.sorted('test_group_no') if result_sets else []"/>

                        <div class="lab-section">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>رقم الكتاب</th>
                                        <th>تاريخ الكتاب</th>
                                        <th>رقم الطلب</th>
                                        <th>تاريخ الطلب</th>
                                        <th>تاريخ الاستلام</th>
                                        <th>عدد النماذج</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td t-esc="task.book_number if task and task.book_number else ''"/>
                                        <td t-esc="task.book_date.strftime('%Y-%m-%d') if task and task.book_date else ''"/>
                                        <td t-esc="sample.sale_order_id.name if sample.sale_order_id else ''"/>
                                        <td t-esc="sample.sale_order_id.date_order.strftime('%Y-%m-%d') if sample.sale_order_id and sample.sale_order_id.date_order else ''"/>
                                        <td t-esc="sample.create_date.strftime('%Y-%m-%d') if sample.create_date else ''"/>
                                        <td t-esc="len(sorted_sets)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <t t-foreach="sorted_sets" t-as="rs">
                            <div class="lab-section" style="margin-top:6px;">
                                <h4 class="subhead" style="text-align:center;">نتائج المجموعة رقم
                                    <t t-esc="rs.test_group_no or 1"/>
                                </h4>
                                <div style="text-align:center;margin:2px 0 6px 0;">
                                    <span style="display:inline-block;padding:2px 6px;border:1px solid #ddd;border-radius:6px;background:#f8f9fa;">
                                        <span style="font-weight:bold;">الرمز:</span>
                                        <t t-esc="rs.concrete_field_serial or rs.concrete_field_code or ''"/>
                                    </span>
                                </div>
                            </div>
                            <div class="lab-section">
                                <h4 class="subhead" style="text-align:center;">1- وصف النموذج (المنتج Product)</h4>

                                <t t-set="picking" t-value="sample.stock_picking_id or (sample.task_id and sample.task_id.stock_receipt_id)"/>
                                <t t-set="ign_lines" t-value="picking and picking.move_line_ids.filtered(lambda l: l.product_id and l.product_id.product_tmpl_id and l.product_id.product_tmpl_id.sample_type_id and l.product_id.product_tmpl_id.sample_type_id.code == 'IGNITABILITY') or []"/>
                                <t t-set="ml_candidates" t-value="ign_lines and ign_lines.filtered(lambda l: l.group_no == rs.test_group_no) or ign_lines"/>
                                <t t-set="ml1" t-value="ml_candidates and ml_candidates[0] or False"/>
                                <table class="table table-bordered product-table">
                                    <tr>
                                        <th>النوع</th>
                                        <th>الأبعاد</th>
                                        <th>الكثافة (kg/m³)</th>
                                        <th>الموقع</th>
                                    </tr>
                                    <tr>
                                        <td t-esc="(ml1 and ml1.ign_person_name) or ''"/>
                                        <t t-set="l1_line" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'LENGTH_MM' and l.sample_no == 1)[:1] and rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'LENGTH_MM' and l.sample_no == 1)[0] or False"/>
                                        <t t-set="w1_line" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'WIDTH_MM' and l.sample_no == 1)[:1] and rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'WIDTH_MM' and l.sample_no == 1)[0] or False"/>
                                        <t t-set="l1" t-value="(l1_line and (l1_line.value_text or l1_line.value_numeric)) or ''"/>
                                        <t t-set="w1" t-value="(w1_line and (w1_line.value_text or w1_line.value_numeric)) or ''"/>
                                        <td t-esc="'%s * %s' % (l1, w1)"/>
                                        <td t-esc="int(rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'DENSITY_EST' and l.sample_no == 1)[:1] and rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'DENSITY_EST' and l.sample_no == 1)[0].value_numeric or 0)"/>
                                        <td t-esc="(ml1 and ml1.ign_site_location) or ''"/>
                                    </tr>
                                </table>
                            </div>


                            <div class="lab-section">
                                <h4 class="subhead" style="text-align:center;">1- عينة الاختبار (Specimen Test)</h4>
                                <table class="table table-bordered">
                                    <tr>
                                        <th>الأبعاد</th>
                                        <th>الكثافة (kg/m³)</th>
                                    </tr>
                                    <tr>
                                        <t t-set="l2_line" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'LENGTH_MM' and l.sample_no == 2)[:1] and rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'LENGTH_MM' and l.sample_no == 2)[0] or False"/>
                                        <t t-set="w2_line" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'WIDTH_MM' and l.sample_no == 2)[:1] and rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'WIDTH_MM' and l.sample_no == 2)[0] or False"/>
                                        <t t-set="l2" t-value="(l2_line and (l2_line.value_text or l2_line.value_numeric)) or ''"/>
                                        <t t-set="w2" t-value="(w2_line and (w2_line.value_text or w2_line.value_numeric)) or ''"/>
                                        <td t-esc="'%s * %s' % (l2, w2)"/>
                                        <td t-esc="int(rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'DENSITY_EST' and l.sample_no == 2)[:1] and rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'DENSITY_EST' and l.sample_no == 2)[0].value_numeric or 0)"/>
                                    </tr>
                                </table>
                            </div>

                            <div class="lab-section">
                                <h4 class="subhead" style="text-align:left;">Table (1) - Surface of Specimen</h4>
                                <table class="table table-bordered">
                                    <tr>
                                        <th>مدى انتشار اللهب</th>
                                        <th>الوقت اللازم لوصول اللهب إلى ارتفاع 150 ملم</th>
                                        <th>هل حدث الاشتعال</th>
                                        <th>مدة الاختبار (ث)</th>
                                        <th>فترة الفحص (ث)</th>
                                        <th>النتيجة</th>
                                    </tr>
                                    <tr>
                                        <td>
                                            <t t-set="v" t-value="rs.ign_t1_flame_spread or ''"/>
                                            <t t-if="v == 'ge_150'">تجاوز (150mm)</t>
                                            <t t-elif="v == 'lt_150'">لم يتجاوز (150mm)</t>
                                            <t t-else="">—</t>
                                        </td>
                                        <td t-esc="rs.ign_t1_time_to_150 or 'لم يصل'"/>
                                        <td>
                                            <t t-if="rs.ign_t1_ignition_happened == 'yes'">نعم</t>
                                            <t t-elif="rs.ign_t1_ignition_happened == 'no'">لا</t>
                                            <t t-else="">—</t>
                                        </td>
                                        <td t-esc="rs.ign_t1_surface_time_of_test or ''"/>
                                        <td t-esc="rs.ign_t1_surface_duration or ''"/>
                                        <td>
                                            <t t-if="rs.overall_result == 'pass'">ناجح</t>
                                            <t t-elif="rs.overall_result == 'fail'">فاشل</t>
                                            <t t-else="">—</t>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <t t-if="rs.ign_show_second_table">
                                <div class="lab-section">
                                    <h4 class="subhead" style="text-align:left;">Table (2) - Edge of Specimen</h4>
                                    <table class="table table-bordered">
                                        <tr>
                                            <th>مدى انتشار اللهب</th>
                                            <th>الوقت اللازم لوصول اللهب إلى ارتفاع 150 ملم</th>
                                            <th>هل حدث الاشتعال</th>
                                            <th>مدة الاختبار (ث)</th>
                                            <th>فترة الفحص (ث)</th>
                                            <th>النتيجة</th>
                                        </tr>
                                        <tr>
                                            <td>
                                                <t t-set="v2" t-value="rs.ign_t2_flame_spread or ''"/>
                                                <t t-if="v2 == 'ge_150'">تجاوز (150mm)</t>
                                                <t t-elif="v2 == 'lt_150'">لم يتجاوز (150mm)</t>
                                                <t t-else="">—</t>
                                            </td>
                                            <td t-esc="rs.ign_t2_time_to_150 or 'لم يصل'"/>
                                            <td>
                                                <t t-if="rs.ign_t2_ignition_happened == 'yes'">نعم</t>
                                                <t t-elif="rs.ign_t2_ignition_happened == 'no'">لا</t>
                                                <t t-else="">—</t>
                                            </td>
                                            <td t-esc="rs.ign_t2_edge_time_of_test or ''"/>
                                            <td t-esc="rs.ign_t2_edge_duration or ''"/>
                                            <td>
                                                <t t-if="rs.overall_result == 'pass'">ناجح</t>
                                                <t t-elif="rs.overall_result == 'fail'">فاشل</t>
                                                <t t-else="">—</t>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </t>
                        </t>

                        

                        <t t-if="sample.notes">
                            <div class="lab-section" style="page-break-inside: avoid;">
                                <h4 class="subhead">الملاحظات</h4>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <div t-field="sample.notes"/>
                                </div>
                            </div>
                        </t>


                        <t t-set="media_urls" t-value="[rs.external_media_url for rs in result_sets if rs.external_media_url]"/>
                        <t t-if="media_urls">
                            <div class="lab-section" style="page-break-inside: avoid; margin-top: 8px;">
                                <table class="table table-bordered">
                                    <tr>
                                        <td style="background-color:#DDDDDD; font-weight:bold; width:30%;">روابط وسائط الفحص</td>
                                        <td>
                                            <ul style="margin:0; padding-inline-start:18px; text-align:right;">
                                                <t t-foreach="media_urls" t-as="mu">
                                                    <li style="text-align:right;"><a t-att-href="mu" target="_blank"><t t-esc="mu"/></a></li>
                                                </t>
                                            </ul>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </t>


                        <div class="lab-section" style="page-break-inside: avoid; margin-top: 16px;">
                            <table style="width:100%;border-collapse:collapse;direction:rtl;">
                                <tr>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الوحدة</div>
                                        <t t-if="sample.exec_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.exec_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.exec_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الجودة</div>
                                        <t t-if="sample.super_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.super_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.super_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">المدير التنفيذي</div>
                                        <t t-if="sample.company_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.company_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.company_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>


                        <t t-foreach="sorted_sets" t-as="rs">
                            <t t-if="rs.ign_image1 or rs.ign_image2 or rs.ign_image3 or rs.ign_image4">
                                <div class="lab-section" style="page-break-inside: avoid; margin-top: 10px;">


                                    <table style="width:100%; border-collapse:collapse;">
                                        <tr>
                                            <td style="width:50%; border:1px solid #e2e2e2; padding:6px; text-align:center; vertical-align:middle;">
                                                <t t-if="rs.ign_image1">
                                                    <img t-att-src="image_data_uri(rs.ign_image1)" style="max-width:100%; height:390px; object-fit:contain;"/>
                                                </t>
                                            </td>
                                            <td style="width:50%; border:1px solid #e2e2e2; padding:6px; text-align:center; vertical-align:middle;">
                                                <t t-if="rs.ign_image2">
                                                    <img t-att-src="image_data_uri(rs.ign_image2)" style="max-width:100%; height:390px; object-fit:contain;"/>
                                                </t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width:50%; border:1px solid #e2e2e2; padding:6px; text-align:center; vertical-align:middle;">
                                                <t t-if="rs.ign_image3">
                                                    <img t-att-src="image_data_uri(rs.ign_image3)" style="max-width:100%; height:390px; object-fit:contain;"/>
                                                </t>
                                            </td>
                                            <td style="width:50%; border:1px solid #e2e2e2; padding:6px; text-align:center; vertical-align:middle;">
                                                <t t-if="rs.ign_image4">
                                                    <img t-att-src="image_data_uri(rs.ign_image4)" style="max-width:100%; height:390px; object-fit:contain;"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </t>
                        </t>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
