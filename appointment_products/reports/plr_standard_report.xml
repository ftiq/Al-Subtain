<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="plr_standard_report">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="sample">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        <style>
                            * { font-family: Arial, sans-serif !important; }
                            .section-title { background:#eef3ff;border:1px solid #cdd9ff;border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;font-size:22px;font-weight:700; }
                            .greeting { text-align: right; margin: 16px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #17a2b8; font-size: 16px; line-height: 1.7; }
                            .table { width:100%; border-collapse:collapse; margin: 0; }
                            .table th { background:#DDDDDD; font-weight:bold; text-align:center; padding:6px 5px; border:1px solid #dee2e6; font-size:12px; }
                            .table thead th, .table tr th { text-align:center !important; vertical-align:middle; }
                            .table td { text-align:center; padding:5px 5px; border:1px solid #dee2e6; font-size:12px; }
                            .lab-section { margin: 6px 0; }
                            .lab-code-badge { display:inline-block;padding:2px 6px;border:1px solid #ddd;border-radius:6px;background:#f8f9fa; }
                            .note-block { padding: 8px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8; }
                            .muted { color: #6c757d; }
                        </style>

                        <t t-set="task" t-value="sample.task_id or False"/>
                        <t t-set="ctype" t-value="(task and (task.plr_course_type or 'surface') or 'surface').lower()"/>
                        <t t-set="ctype_label">
                            <t t-if="ctype == 'surface'">فحص طبقة سطحية</t>
                            <t t-elif="ctype in ['binder','binder_base']">فحص طبقة رابطة/أساس</t>
                            <t t-elif="ctype == 'base'">فحص طبقة أساس</t>
                            <t t-else="">فحص انتظام التبليط</t>
                        </t>

                        <div class="section-title">
                            تقرير فحص انتظام التبليط
                            <t t-if="ctype_label"> (</t><t t-esc="ctype_label"/><t t-if="ctype_label">)</t>
                        </div>

                        <div class="greeting">
                            <p style="margin: 0;">تحية طيبة ..</p>
                            <p style="margin: 0;">ندرج نتائج فحص النماذج المبينة تفاصيلها ادناه. راجين الاطلاع ...مع التقدير</p>
                        </div>

                        <!-- Header Info Table -->
                        <div class="lab-section">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>رقم الكتاب</th>
                                        <th>تاريخ الكتاب</th>
                                        <th>رقم الطلب</th>
                                        <th>تاريخ الطلب</th>
                                        <th>تاريخ الاستلام</th>
                                        <th>عدد المقاطع</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td t-esc="task.book_number if task and task.book_number else ''"/>
                                        <td t-esc="task.book_date.strftime('%Y-%m-%d') if task and task.book_date else ''"/>
                                        <td t-esc="sample.sale_order_id.name if sample.sale_order_id else ''"/>
                                        <td t-esc="sample.sale_order_id.date_order.strftime('%Y-%m-%d') if sample.sale_order_id and sample.sale_order_id.date_order else ''"/>
                                        <td t-esc="sample.create_date.strftime('%Y-%m-%d') if sample.create_date else ''"/>
                                        <t t-set="segments" t-value="(task and task.plr_segment_ids and task.plr_segment_ids.sorted('segment_no')) or []"/>
                                        <td t-esc="len(segments)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Road Info -->
                        <div class="lab-section" t-if="task">
                            <div style="text-align:right; font-weight:bold;">
                                <span>اسم الطريق:</span>
                                <span t-esc="task.plr_street_name or ''"/>
                                <span style="margin-right:14px;">طول:</span>
                                <span t-esc="'{:.0f} م'.format(task.plr_street_length or 0)"/>
                            </div>
                        </div>

                        <!-- Main PLR Table -->
                        <t t-set="rs_all" t-value="sample.result_set_ids.filtered(lambda r: r.template_id and r.template_id.code == 'PAVEMENT_LONG_REG')"/>
                        <t t-set="rs" t-value="(rs_all and rs_all[0]) or False"/>
                        <t t-if="rs and segments">
                            <div class="lab-section" style="margin-top:6px;">
                                <table class="table table-bordered" style="table-layout:fixed;">
                                    <colgroup>
                                        <col style="width:22%;"/>
                                        <col style="width:13%;"/>
                                        <col style="width:10%;"/>
                                        <col style="width:10%;"/>
                                        <col style="width:10%;"/>
                                        <col style="width:10%;"/>
                                        <col style="width:10%;"/>
                                        <col style="width:10%;"/>
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th rowspan="2">المحطة لكل ٣٠٠ متر</th>
                                            <th rowspan="2">المقطع</th>
                                            <th colspan="2">mm (5.9–4)</th>
                                            <th colspan="2">mm (10–6)</th>
                                            <th colspan="2">أكبر من 10 mm</th>
                                        </tr>
                                        <tr>
                                            <th>الانحراف</th>
                                            <th>حد مسموح</th>
                                            <th>الانحراف</th>
                                            <th>حد مسموح</th>
                                            <th>الانحراف</th>
                                            <th>حد مسموح</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="segments" t-as="seg">
                                            <t t-set="a_lines" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'PLR_4_59' and l.sample_no == seg.segment_no)"/>
                                            <t t-set="b_lines" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'PLR_6_10' and l.sample_no == seg.segment_no)"/>
                                            <t t-set="c_lines" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'PLR_GT10' and l.sample_no == seg.segment_no)"/>
                                            <t t-set="r_lines" t-value="rs.result_line_ids.filtered(lambda l: l.criterion_id and l.criterion_id.code == 'PLR_SEG_RATIO' and l.sample_no == seg.segment_no)"/>

                                            <t t-set="a_val" t-value="(a_lines and a_lines[0].value_numeric) or 0"/>
                                            <t t-set="b_val" t-value="(b_lines and b_lines[0].value_numeric) or 0"/>
                                            <t t-set="c_val" t-value="(c_lines and c_lines[0].value_numeric) or 0"/>

                                            <t t-set="seg_len" t-value="(int(seg.end_m or 0) - int(seg.start_m or 0))"/>
                                            <t t-set="ratio_alt" t-value="(seg_len/300.0) if seg_len else 1.0"/>
                                            <t t-set="ratio" t-value="(r_lines and r_lines[0].value_numeric) or ratio_alt"/>

                                            <t t-set="is_surface" t-value="1 if ctype == 'surface' else 0"/>
                                            <t t-set="base_a" t-value="20 if is_surface else 40"/>
                                            <t t-set="base_b" t-value="0 if is_surface else 3"/>
                                            <t t-set="base_c" t-value="0"/>

                                            <t t-set="allow_a" t-value="base_a * (ratio or 1.0)"/>
                                            <t t-set="allow_b" t-value="base_b * (ratio or 1.0)"/>
                                            <t t-set="allow_c" t-value="base_c * (ratio or 1.0)"/>

                                            <tr>
                                                <td t-esc="seg.station_range or ''"/>
                                                <td t-esc="seg.segment_no"/>
                                                <td>
                                                    <t t-esc="'{:.0f}'.format(a_val)"/>
                                                    <t t-if="a_val &gt; allow_a"><sup>*</sup></t>
                                                </td>
                                                <td>
                                                    <t t-esc="'{:.0f}'.format(allow_a)"/>
                                                    <t t-if="(ratio or 0) &lt; 0.999"><sup>*</sup></t>
                                                </td>
                                                <td>
                                                    <t t-esc="'{:.0f}'.format(b_val)"/>
                                                    <t t-if="b_val &gt; allow_b"><sup>*</sup></t>
                                                </td>
                                                <td>
                                                    <t t-esc="'{:.0f}'.format(allow_b)"/>
                                                    <t t-if="(ratio or 0) &lt; 0.999"><sup>*</sup></t>
                                                </td>
                                                <td>
                                                    <t t-esc="'{:.0f}'.format(c_val)"/>
                                                    <t t-if="c_val &gt; allow_c"><sup>*</sup></t>
                                                </td>
                                                <td>
                                                    <t t-esc="'{:.0f}'.format(allow_c)"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </t>
                        <t t-else="">
                            <p style="text-align:center;">لا توجد نتائج فحص انتظام التبليط متاحة للعرض</p>
                        </t>

                        <!-- Notes -->
                        <t t-if="sample.notes">
                            <div class="lab-section" style="page-break-inside: avoid;">
                                <h4 style="margin:2px 0;">الملاحظات</h4>
                                <div class="note-block">
                                    <div t-field="sample.notes"/>
                                </div>
                            </div>
                        </t>

                        <!-- Signatures -->
                        <div class="lab-section" style="page-break-inside: avoid; margin-top: 16px;">
                            <table style="width:100%;border-collapse:collapse;direction:rtl;">
                                <tr>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الوحدة</div>
                                        <t t-if="sample.exec_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.exec_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.exec_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">مسؤول الجودة</div>
                                        <t t-if="sample.super_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.super_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.super_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                    <td style="width:10px;"/>
                                    <td style="width:33.33%;text-align:center;padding:10px;border:1px solid #e2e2e2;background:#ffffff;">
                                        <div style="margin-bottom:6px;font-weight:bold;">المدير التنفيذي</div>
                                        <t t-if="sample.company_signature">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;display:flex;align-items:center;justify-content:center;">
                                                <img t-att-src="image_data_uri(sample.company_signature)" style="max-width:100%;max-height:100%;"/>
                                            </div>
                                            <div style="font-size:12px;" t-esc="sample.company_signer_name or ''"/>
                                        </t>
                                        <t t-else="">
                                            <div style="height:70px;border:1px solid #ddd;margin:8px 0;"/>
                                            <div style="font-size:12px;">الاسم/ ____________</div>
                                        </t>
                                    </td>
                                </tr>
                            </table>
                        </div>

                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>
