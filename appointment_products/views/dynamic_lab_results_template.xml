<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- تقرير النتائج المختبرية الديناميكي -->
    <template id="dynamic_lab_results_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <div class="page">
                        <!-- أنماط مخصصة للتقرير -->
                        <style>
                            @font-face {
                                font-family: 'tradbdo';
                                src: url('/appointment_products/static/src/fonts/tradbdo.ttf') format('truetype');
                                font-weight: bold;
                                font-style: normal;
                            }
                            
                            /* تطبيق الخط على كامل التقرير */
                            .page {
                                font-family: 'tradbdo', Arial, sans-serif !important;
                                background: #fff;
                                padding: 20px;
                                font-size: 15px;
                            }
                            
                            /* العنوان الرئيسي */
                            .custom-main-title {
                                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                                color: #000 !important;
                                padding: 15px;
                                margin: 8px 0 15px 0;
                                border-radius: 12px;
                                text-align: center;
                                font-family: 'tradbdo', Arial, sans-serif !important;
                                font-size: 20px !important;
                                font-weight: 600;
                                box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
                                border: 2px solid #1e3c72;
                                position: relative;
                                overflow: hidden;
                            }
                            
                            .custom-main-title::before {
                                content: '';
                                position: absolute;
                                top: 0;
                                left: -100%;
                                width: 100%;
                                height: 100%;
                                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                                animation: shine 3s infinite;
                            }
                            
                            @keyframes shine {
                                0% { left: -100%; }
                                50% { left: 100%; }
                                100% { left: 100%; }
                            }
                            
                            /* أقسام المختبر */
                            .lab-section {
                                background: #fff;
                                border: 1px solid #dee2e6;
                                border-radius: 8px;
                                margin: 4px 0;
                                padding: 8px;
                            }
                            
                            .lab-section h3, .lab-section h4 {
                                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                                color: #000 !important;
                                padding: 6px 8px;
                                margin: -8px -8px 8px -8px;
                                border-radius: 10px 10px 0 0;
                                font-weight: 600;
                                font-size: 16px !important;
                                text-align: center;
                                font-family: 'tradbdo', Arial, sans-serif !important;
                                border-bottom: 2px solid #28a745;
                                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.25);
                                position: relative;
                            }
                            

                            .lab-section h3::after, .lab-section h4::after {
                                content: '';
                                position: absolute;
                                bottom: -2px;
                                left: 50%;
                                transform: translateX(-50%);
                                width: 50px;
                                height: 3px;
                                background: #fff;
                                border-radius: 2px;
                            }
                            
                            /* تحسينات الجداول */
                            .table {
                                width: 100%;
                                border-collapse: collapse;
                                background: #fff;
                                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                                border-radius: 8px;
                                overflow: hidden;
                                font-size: 14px;
                            }
                            
                            .table td, .table th {
                                text-align: center !important;
                                vertical-align: middle !important;
                                font-family: 'tradbdo', Arial, sans-serif !important;
                                color: #000 !important;
                                border: 1px solid #dee2e6;
                                padding: 8px 6px;
                            }
                            
                            .table th {
                                background: rgba(13, 110, 253, 0.1);
                                color: #0d6efd !important;
                                font-weight: 600;
                                font-size: 14px;
                            }
                            
                            .table thead th {
                                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                                color: black !important;
                                font-weight: bold;
                            }
                            

                            .table td:first-child {
                                text-align: center !important;
                            }
                            
                            .table.table-sm td:first-child {
                                text-align: right !important;
                                font-weight: bold;
                            }
                            
                            /* محاذاة يمين لرأس التقرير */
                            .text-end {
                                text-align: left !important;
                            }
                            
                            /* عناوين المقاطع */
                            h1, h2, h3, h4, h5, h6 {
                                font-family: 'TraditionalArabic', Arial, sans-serif !important;
                            }
                            
                            /* جميع النصوص */
                            p, span, div, strong {
                                font-family: 'TraditionalArabic', Arial, sans-serif !important;
                            }
                            
                            /* شارات الحالة */
                            .badge {
                                font-family: 'TraditionalArabic', Arial, sans-serif !important;
                            }
                            
                            /* تحسينات إضافية - زيادة حجم الخط */
                            .table {
                                font-size: 16px;
                                line-height: 1.6;
                            }
                            
                            /* ألوان جميلة للجداول */
                            .table-active {
                                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
                                color: black !important;
                                font-weight: bold;
                            }
                            
                            .table-light {
                                background: rgba(13, 110, 253, 0.1) !important;
                                color: #0d6efd !important;
                            }
                            
                            /* شارات الحالة المحسنة */
                            .badge {
                                font-family: 'tradbdo', Arial, sans-serif !important;
                                font-size: 12px;
                                padding: 4px 8px;
                                border-radius: 6px;
                                font-weight: 600;
                            }
                            
                            .badge-success {
                                background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
                                color: black !important;
                                box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
                            }

                            .badge-danger {
                                background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
                                color: black !important;
                                box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
                            }

                            .badge-info {
                                background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%) !important;
                                color: black !important;
                                box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
                            }

                            .badge-warning {
                                background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
                                color: black !important;
                                box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
                            }
                            
                            .badge-secondary {
                                background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
                                color: black !important;
                                box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
                            }
                            
                            /* العناوين والنصوص الملونة */
                            h1, h2, h3, h4, h5, h6 {
                                font-family: 'tradbdo', Arial, sans-serif !important;
                            }
                            
                            h2, h4 {
                                color: #1e3c72 !important;
                                text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
                                margin-bottom: 8px !important;
                            }
                            
                            p, span, div, strong {
                                font-family: 'tradbdo', Arial, sans-serif !important;
                            }
                            
                            .text-muted {
                                color: #1e3c72 !important;
                            }

                            .text-primary {
                                color: #0d6efd !important;
                            }
                            
                            .text-success {
                                color: #28a745 !important;
                            }
                            
                            .text-danger {
                                color: #dc3545 !important;
                            }
                            

                            /* تحسينات الهوامش والمسافات */
                            .mb16 {
                                margin-bottom: 16px !important;
                            }

                            .mt-3 {
                                margin-top: 1rem !important;
                            }

                            .mb-3 {
                                margin-bottom: 1rem !important;
                            }
                            
                            .mt32 {
                                margin-top: 2rem !important;
                            }
                            
                            .mb32 {
                                margin-bottom: 2rem !important;
                            }
                            
                            /* تحسينات الجداول الصغيرة */
                            .table-sm {
                                font-size: 13px !important;
                            }

                            .table-sm th {
                                padding: 6px !important;
                                font-size: 13px !important;
                            }

                            .table-sm td {
                                padding: 6px !important;
                                font-size: 13px !important;
                                line-height: 1.4 !important;
                            }
                            
                            .table.table-sm td:first-child {
                                text-align: right !important;
                                font-weight: bold;
                            }
                            
                            /* محاذاة النصوص */
                            .text-end {
                                text-align: left !important;
                            }
                            
                            /* تحسينات للطباعة */
                            @media print {
                                .lab-section {
                                    page-break-inside: avoid;
                                }
                                
                                .lab-section h3, .lab-section h4 {
                                    page-break-after: avoid !important;
                                }
                            }
                        </style>
                        
                        <div class="oe_structure"/>
                        
                        <!-- العنوان الرئيسي -->
                        <div class="custom-main-title">
                            <span>م/ تقرير فحص طابوق (طيني)</span>
                            <br/>
                            <span style="font-size: 16px; opacity: 0.8;">Clay Brick Testing Report</span>
                            <br/>
                            <span style="font-size: 14px; opacity: 0.8;">تاريخ التقرير: <span t-esc="datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')"/></span>
                        </div>
                        
                        <!-- معلومات العينة الأساسية -->
                        <div class="lab-section">
                            <h3>معلومات العينة</h3>
                            <table class="table table-bordered">
                                <tr>
                                    <td style="background-color: #D9E1F2; font-weight: bold; width: 15%;">رقم العينة:</td>
                                    <td style="width: 18%;" t-esc="doc.name or ''"/>
                                    <td style="background-color: #D9E1F2; font-weight: bold; width: 15%;">المنتج:</td>
                                    <td style="width: 35%;" colspan="3" t-esc="doc.product_id.name or ''"/>
                                </tr>
                                <tr>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">النوع الفرعي:</td>
                                    <td t-esc="doc.sample_subtype_id.name or ''"/>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">الكمية:</td>
                                    <td t-esc="doc.task_id.total_samples_count or doc.quantity or 0"/>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">الحالة:</td>
                                    <td t-esc="doc.state or ''"/>
                                </tr>
                                <tr>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">العميل:</td>
                                    <td t-esc="doc.task_id.partner_id.name or ''"/>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">المشروع:</td>
                                    <td colspan="3">
                                        <t t-set="first_answer" t-value="doc.task_id.fsm_question_ids[:1] if doc.task_id.fsm_question_ids else False"/>
                                        <t t-if="first_answer">
                                            <t t-if="first_answer.value_text_box">
                                                <span t-esc="first_answer.value_text_box"/>
                                            </t>
                                            <t t-elif="first_answer.value_answer_id">
                                                <span t-field="first_answer.value_answer_id.value"/>
                                            </t>
                                            <t t-else="">
                                                <span t-field="doc.task_id.project_id.name"/>
                                            </t>
                                        </t>
                                        <t t-else="">
                                            <span t-field="doc.task_id.project_id.name"/>
                                        </t>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">تاريخ الاستلام:</td>
                                    <td t-esc="doc.received_date or ''"/>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">الطلب:</td>
                                    <td t-esc="doc.task_id.name or ''"/>
                                    <td style="background-color: #D9E1F2; font-weight: bold;">الرمز الحقلي:</td>
                                    <td t-esc="doc.field_serial or ''"/>
                                </tr>
                            </table>
                        </div>

                        <!-- ملخص النتائج -->
                        <t t-set="result_sets" t-value="doc.result_set_ids.sorted('name') if doc.result_set_ids else []"/>
                        <div class="summary-card">
                            <h3>ملخص النتائج</h3>
                            <t t-set="total_result_sets" t-value="len(result_sets) if result_sets else 0"/>
                            <t t-set="completed_sets" t-value="len([x for x in result_sets if x.state in ['approved', 'completed']]) if result_sets else 0"/>
                            <t t-set="passed_tests" t-value="0"/>
                            <t t-set="failed_tests" t-value="0"/>
                            
                            <!-- حساب النتائج المطابقة وغير المطابقة -->
                            <t t-if="result_sets">
                                <t t-foreach="result_sets" t-as="rs">
                                    <t t-set="has_failed_criterion" t-value="False"/>
                                    <t t-if="rs.result_line_ids">
                                        <t t-foreach="rs.result_line_ids" t-as="line">
                                            <t t-if="'COMP_STRENGTH' in (line.criterion_id.code or '') or 'EFFLOR' in (line.criterion_id.code or '')">
                                                <t t-set="min_limit" t-value="line.criterion_id.min_value if line.criterion_id.min_value else 0"/>
                                                <t t-set="max_limit" t-value="line.criterion_id.max_value if line.criterion_id.max_value else 999"/>
                                                <t t-set="value" t-value="line.value_numeric or 0"/>
                                                <t t-if="not (min_limit &lt;= value &lt;= max_limit)">
                                                    <t t-set="has_failed_criterion" t-value="True"/>
                                                </t>
                                            </t>
                                        </t>
                                    </t>
                                    <t t-if="has_failed_criterion">
                                        <t t-set="failed_tests" t-value="failed_tests + 1"/>
                                    </t>
                                    <t t-else="">
                                        <t t-set="passed_tests" t-value="passed_tests + 1"/>
                                    </t>
                                </t>
                            </t>
                            
                            <table class="table table-bordered">
                                <tr>
                                    <td style="background-color: #E2EFDA; font-weight: bold; width: 15%;">إجمالي الفحوصات:</td>
                                    <td style="width: 18%;" t-esc="total_result_sets"/>
                                    <td style="background-color: #E2EFDA; font-weight: bold; width: 15%;">المكتملة:</td>
                                    <td style="width: 18%;" t-esc="completed_sets"/>
                                    <td style="background-color: #E2EFDA; font-weight: bold; width: 15%;">الناجحة:</td>
                                    <td style="background-color: #C6EFCE;" t-esc="passed_tests"/>
                                </tr>
                                <tr>
                                    <td style="background-color: #E2EFDA; font-weight: bold;">الفاشلة:</td>
                                    <td style="background-color: #FFC7CE;" t-esc="failed_tests"/>
                                    <td style="background-color: #E2EFDA; font-weight: bold;">نسبة التقدم:</td>
                                    <td t-esc="str(doc.progress_percentage) + '%' if doc.progress_percentage else '0%'"/>
                                    <td style="background-color: #E2EFDA; font-weight: bold;">النتيجة الإجمالية:</td>
                                    <td t-attf-style="font-weight: bold; background-color: #{failed_tests > 0 and '#FFC7CE' or '#C6EFCE'};" t-esc="failed_tests > 0 and 'فاشل' or 'ناجح'"/>
                                </tr>
                            </table>
                        </div>

                        <t t-if="result_sets">
                            <t t-foreach="result_sets" t-as="result_set">
                                <div class="lab-section">
                                    <t t-if="result_set.result_line_ids">

                                        <t t-if="'BRICK_DIMENS' in (result_set.template_id.code or '') or 'DIMENS_BRICK' in (result_set.template_id.code or '')">
                                            <t t-set="sample_count" t-value="len(set(result_set.result_line_ids.mapped('sample_no')))"/>
                                            <h3><span t-field="result_set.template_id.name"/> (<t t-esc="sample_count"/>) 
                                                <small class="text-muted">(<span t-field="result_set.template_id.code"/>)</small>
                                            </h3>                              

                                            <div class="mb16">
                                                <p class="text-muted">
                                                    <strong>تاريخ الفحص:</strong> <span t-field="result_set.testing_date"/>
                                                    <t t-if="result_set.technician_id">
                                                        | <strong>الفني:</strong> <span t-field="result_set.technician_id.name"/>
                                                    </t>
                                                </p>
                                            </div>

                                            <t t-set="computed_lines" t-value="result_set.result_line_ids.filtered(lambda x: x.criterion_id.test_type == 'computed')"/>
                                            <t t-if="computed_lines">
                                                <t t-set="computed_sample_count" t-value="len(computed_lines)"/>
                                                <h4 style="background-color: #28a745; color: white; padding: 8px; text-align: center; border-radius: 5px;">القياسات المحسوبة (<t t-esc="computed_sample_count"/>)</h4>
                                                <table class="table table-bordered">
                                                    <thead class="table-active">
                                                        <tr>
                                                            <th class="text-center">المعيار</th>
                                                            <th class="text-center">الوحدة</th>
                                                            <th class="text-center">القيمة العليا</th>
                                                            <th class="text-center">القيمة الدنيا</th>
                                                            <th class="text-center">النتيجة</th>
                                                            <th class="text-center">الحالة</th>
                                                        </tr>
                                                    </thead>
                                                        <tbody>
                                                            <t t-foreach="computed_lines.mapped('criterion_id').sorted('sequence')" t-as="criterion">
                                                                <t t-set="criterion_lines" t-value="computed_lines.filtered(lambda x: x.criterion_id == criterion)"/>
                                                                <t t-if="criterion_lines">

                                                                     <t t-set="computed_values" t-value="[line.value_numeric for line in criterion_lines if line.value_numeric]"/>
                                                                     <t t-set="current_value" t-value="computed_values[0] if computed_values else 0"/>
                                                                     <t t-set="min_val" t-value="criterion.min_value if criterion.min_value else (current_value * 0.95)"/>
                                                                     <t t-set="max_val" t-value="criterion.max_value if criterion.max_value else (current_value * 1.05)"/>
                                                                     <t t-set="display_values" t-value="[min_val, current_value, max_val]"/>
                                                                    <t t-if="display_values">
                                                                     <t t-set="avg_value" t-value="current_value"/>
                                                                     <t t-set="min_limit" t-value="criterion.min_value if criterion.min_value else (current_value * 0.95)"/>
                                                                     <t t-set="max_limit" t-value="criterion.max_value if criterion.max_value else (current_value * 1.05)"/>

                                                                     <t t-set="is_compliant" t-value="min_limit &lt;= avg_value and avg_value &lt;= max_limit"/>
                                                                     <tr>
                                                                         <td>
                                                                             <strong><span t-esc="criterion.name"/></strong>
                                                                             <br/>
                                                                             <small class="text-muted">(<span t-esc="criterion.code"/>)</small>
                                                                         </td>
                                                                          <td class="text-center">
                                                                              <t t-if="criterion.uom_id">
                                                                                  <span t-esc="criterion.uom_id.name"/>
                                                                              </t>
                                                                              <t t-else="">-</t>
                                                                          </td>
                                                                           <td class="text-center">
                                                                               <t t-if="criterion.max_value">
                                                                                   <strong class="text-success"><span t-esc="round(criterion.max_value, 2)"/></strong>
                                                                               </t>
                                                                               <t t-else="">
                                                                                   <strong class="text-success"><span t-esc="round(current_value * 1.05, 2)"/></strong>
                                                                               </t>
                                                                           </td>
                                                                           <td class="text-center">
                                                                               <t t-if="criterion.min_value">
                                                                                   <strong class="text-danger"><span t-esc="round(criterion.min_value, 2)"/></strong>
                                                                               </t>
                                                                               <t t-else="">
                                                                                   <strong class="text-danger"><span t-esc="round(current_value * 0.95, 2)"/></strong>
                                                                               </t>
                                                                           </td>
                                                                          <td class="text-center">
                                                                              <strong class="text-primary"><span t-esc="round(avg_value, 2)"/></strong>
                                                                          </td>
                                                                         <td class="text-center">
                                                                             <t t-if="is_compliant">
                                                                                 <span class="badge badge-success">مطابق</span>
                                                                             </t>
                                                                             <t t-else="">
                                                                                 <span class="badge badge-danger">غير مطابق</span>
                                                                             </t>
                                                                          </td>
                                                                     </tr>
                                                                    </t>
                                                                </t>
                                                            </t>
                                                            

                                                            <t t-set="chipping_line" t-value="result_set.result_line_ids.filtered(lambda x: 'CHIPPING_PCT' in x.criterion_id.code)"/>
                                                            <t t-if="chipping_line">
                                                                <t t-set="chipping_value" t-value="chipping_line[0].value_numeric or 0"/>
                                                                <t t-set="is_chipping_compliant" t-value="chipping_value &lt;= 10"/>
                                                                <tr>
                                                                    <td>
                                                                        <strong><span t-esc="chipping_line[0].criterion_id.name"/></strong>
                                                                        <br/>
                                                                        <small class="text-muted">(<span t-esc="chipping_line[0].criterion_id.code"/>)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="chipping_line[0].criterion_id.uom_id">
                                                                            <span t-esc="chipping_line[0].criterion_id.uom_id.name"/>
                                                                        </t>
                                                                        <t t-else="">-</t>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-success">10.0</strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-danger">0.0</strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-primary"><span t-esc="round(chipping_value, 1)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="is_chipping_compliant">
                                                                            <span class="badge badge-success">مطابق</span>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <span class="badge badge-danger">غير مطابق</span>
                                                                        </t>
                                                                    </td>
                                                                </tr>
                                                            </t>
                                                        </tbody>
                                                    </table>
                                                </t>
                                                <t t-else="">
                                                    <div class="alert alert-info">
                                                        <p>لا توجد حقول محسوبة لقالب أبعاد الطابوق</p>
                                                    </div>
                                                </t>
                                                

                                                <t t-set="appearance_lines" t-value="result_set.result_line_ids.filtered(lambda x: 'UNIFORMITY' in x.criterion_id.code or 'CORNERS' in x.criterion_id.code or 'SHAPE' in x.criterion_id.code)"/>
                                                <t t-if="appearance_lines">
                                                    <div class="mt-3 mb-3">
                                                        <t t-set="appearance_sample_count" t-value="len(appearance_lines)"/>
                                                        <div class="d-flex flex-wrap align-items-center">
                                                            <h6 class="text-muted mb-0 me-3">الشكل العام (<t t-esc="appearance_sample_count"/>):</h6>
                                                            <t t-foreach="appearance_lines" t-as="line">
                                                                <t t-set="value" t-value="line.value_numeric or 0"/>
                                                                <t t-set="criterion_code" t-value="line.criterion_id.code"/>
                                                                <t t-set="is_compliant" t-value="value == 1"/>
                                                                
                                                                <div class="d-flex align-items-center me-4">
                                                                    <span class="me-1">
                                                                        <t t-if="'UNIFORMITY' in criterion_code">
                                                                            <strong>التجانس:</strong>
                                                                        </t>
                                                                        <t t-elif="'CORNERS' in criterion_code">
                                                                            <strong>الزوايا:</strong>
                                                                        </t>
                                                                        <t t-elif="'SHAPE' in criterion_code">
                                                                            <strong>الشكل:</strong>
                                                                        </t>
                                                                    </span>
                                                                    <span class="me-1">←</span>
                                                                    <span>
                                                                        <t t-if="is_compliant">
                                                                            <t t-if="'UNIFORMITY' in criterion_code">
                                                                                <span class="badge badge-success">متجانس</span>
                                                                            </t>
                                                                            <t t-elif="'CORNERS' in criterion_code">
                                                                                <span class="badge badge-success">مطابقة</span>
                                                                            </t>
                                                                            <t t-elif="'SHAPE' in criterion_code">
                                                                                <span class="badge badge-success">مطابق</span>
                                                                            </t>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <t t-if="'UNIFORMITY' in criterion_code">
                                                                                <span class="badge badge-danger">غير متجانس</span>
                                                                            </t>
                                                                            <t t-elif="'CORNERS' in criterion_code">
                                                                                <span class="badge badge-danger">غير مطابقة</span>
                                                                            </t>
                                                                            <t t-elif="'SHAPE' in criterion_code">
                                                                                <span class="badge badge-danger">غير مطابق</span>
                                                                            </t>
                                                                        </t>
                                                                    </span>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </t>
                                            </t>

                                            <t t-elif="'EFFLOR' in (result_set.template_id.code or '')">

                                                <t t-set="sample_count" t-value="len(set(result_set.result_line_ids.mapped('sample_no')))"/>
                                                <h4><span t-field="result_set.template_id.name"/> (<t t-esc="sample_count"/>) 
                                                    <small class="text-muted">(<span t-field="result_set.template_id.code"/>)</small>
                                                </h4>                              

                                                <div class="mb16">
                                                    <p class="text-muted">
                                                        <strong>تاريخ الفحص:</strong> <span t-field="result_set.testing_date"/>
                                                        <t t-if="result_set.technician_id">
                                                            | <strong>الفني:</strong> <span t-field="result_set.technician_id.name"/>
                                                        </t>
                                                    </p>
                                                </div>
                                                <table class="table table-bordered table-sm">
                                                    <thead class="table-active">
                                                        <tr>
                                                            <th class="text-center">المعيار</th>
                                                            <th class="text-center">التقييم</th>
                                                            <th class="text-center">المطابقة</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="result_set.result_line_ids.sorted('id')" t-as="line">
                                                            <t t-if="'EFFLOR_GRADE' in line.criterion_id.code">
                                                                <t t-set="grade_value" t-value="int(line.value_numeric or 0)"/>
                                                                <t t-set="sample_type" t-value="line.criterion_id.code.split('_')[-1] if '_' in line.criterion_id.code else 'A'"/>
                                                                

                                                                <t t-if="grade_value == 1">
                                                                    <t t-set="assessment" t-value="'لا يوجد تزهر'"/>
                                                                    <t t-set="is_compliant" t-value="True"/>
                                                                </t>
                                                                <t t-elif="grade_value == 2">
                                                                    <t t-set="assessment" t-value="'تزهر خفيف'"/>
                                                                    <t t-set="is_compliant" t-value="sample_type in ['A', 'B']"/>
                                                                </t>
                                                                <t t-elif="grade_value == 3">
                                                                    <t t-set="assessment" t-value="'تزهر متوسط'"/>
                                                                    <t t-set="is_compliant" t-value="sample_type == 'B'"/>
                                                                </t>
                                                                <t t-elif="grade_value == 4">
                                                                    <t t-set="assessment" t-value="'تزهر عالي'"/>
                                                                    <t t-set="is_compliant" t-value="False"/>
                                                                </t>
                                                                <t t-else="">
                                                                    <t t-set="assessment" t-value="'غير محدد'"/>
                                                                    <t t-set="is_compliant" t-value="False"/>
                                                                </t>
                                                                
                                                                <tr>
                                                                    <td class="text-center">
                                                                        <strong><span t-esc="line.criterion_id.name"/></strong>
                                                                        <br/>
                                                                        <small class="text-muted">(<span t-esc="line.criterion_id.code"/>)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="grade_value == 1">
                                                                            <span class="badge badge-success"><span t-esc="assessment"/></span>
                                                                        </t>
                                                                        <t t-elif="grade_value == 2">
                                                                            <span class="badge badge-info"><span t-esc="assessment"/></span>
                                                                        </t>
                                                                        <t t-elif="grade_value == 3">
                                                                            <span class="badge badge-warning"><span t-esc="assessment"/></span>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <span class="badge badge-danger"><span t-esc="assessment"/></span>
                                                                        </t>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="is_compliant">
                                                                            <span class="badge badge-success">مطابق</span>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <span class="badge badge-danger">غير مطابق</span>
                                                                        </t>
                                                                    </td>
                                                                </tr>
                                                            </t>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </t>

                            <t t-elif="'ABSORB' in (result_set.template_id.code or '')">
                                <div style="page-break-before: always;">
                                    <t t-set="sample_count" t-value="len(set(result_set.result_line_ids.mapped('sample_no')))"/>
                                    <h3><span t-field="result_set.template_id.name"/> (<t t-esc="sample_count"/>) 
                                        <small class="text-muted">(<span t-field="result_set.template_id.code"/>)</small>
                                    </h3>
                                    <div class="mb16">
                                        <p class="text-muted">
                                            <strong>تاريخ الفحص:</strong> <span t-field="result_set.testing_date"/>
                                            <t t-if="result_set.technician_id">
                                                | <strong>الفني:</strong> <span t-field="result_set.technician_id.name"/>
                                            </t>
                                        </p>
                                    </div>

                                                <t t-set="non_computed_lines" t-value="result_set.result_line_ids.filtered(lambda x: x.criterion_id.test_type != 'computed' and x.criterion_id.code not in ['DRY_WT_A', 'WET_WT_A', 'DRY_WT_B', 'WET_WT_B', 'DRY_WT_C', 'WET_WT_C'])"/>
                                                <t t-if="non_computed_lines">
                                                    <t t-set="direct_sample_count" t-value="len(non_computed_lines)"/>
                                                    <h4 style="background-color: #17a2b8; color: white; padding: 8px; text-align: center; border-radius: 5px;">القياسات المباشرة (<t t-esc="direct_sample_count"/>)</h4>
                                                    <table class="table table-bordered mb-3">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th class="text-center">المعيار</th>
                                                                <th class="text-center">الوحدة</th>
                                                                <th class="text-center">الحد الأعلى</th>
                                                                <th class="text-center">الحد الأدنى</th>
                                                                <th class="text-center">النتيجة</th>
                                                                <th class="text-center">الحالة</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <t t-foreach="non_computed_lines.sorted('id')" t-as="line">
                                                                <t t-set="min_limit" t-value="line.criterion_id.min_value if line.criterion_id.min_value else 0"/>
                                                                <t t-set="max_limit" t-value="line.criterion_id.max_value if line.criterion_id.max_value else 9999"/>
                                                                <t t-set="value" t-value="line.value_numeric or 0"/>
                                                                <t t-set="is_compliant" t-value="min_limit &lt;= value and value &lt;= max_limit"/>
                                                                <tr>
                                                                    <td>
                                                                        <t t-set="sample_code" t-value="'عينة ' + str(line.sample_no) if line.sample_no else ''"/>
                                                                        <strong>
                                                                            <t t-if="sample_code">
                                                                                <span class="badge badge-secondary me-1" t-esc="sample_code"/>
                                                                            </t>
                                                                            <span t-esc="line.criterion_id.name"/>
                                                                        </strong>
                                                                        <br/>
                                                                        <small class="text-muted">(<span t-esc="line.criterion_id.code"/>)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="line.criterion_id.uom_id">
                                                                            <span t-esc="line.criterion_id.uom_id.name"/>
                                                                        </t>
                                                                        <t t-else="">-</t>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-success"><span t-esc="round(max_limit, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-danger"><span t-esc="round(min_limit, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-primary"><span t-esc="round(value, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="is_compliant">
                                                                            <span class="badge badge-success">مطابق</span>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <span class="badge badge-danger">غير مطابق</span>
                                                                        </t>
                                                                    </td>
                                                                </tr>
                                                            </t>
                                                        </tbody>
                                                    </table>
                                                </t>
                                                

                                                <t t-set="computed_lines" t-value="result_set.result_line_ids.filtered(lambda x: x.criterion_id.test_type == 'computed')"/>
                                                <t t-if="computed_lines">
                                                    <t t-set="computed_sample_count" t-value="len(computed_lines)"/>
                                                    <h6 class="text-muted mb-2">النتائج المحسوبة (<t t-esc="computed_sample_count"/>):</h6>
                                                    <table class="table table-bordered table-sm">
                                                        <thead class="table-active">
                                                            <tr>
                                                                <th class="text-center">المعيار</th>
                                                                <th class="text-center">الوحدة</th>
                                                                <th class="text-center">الحد الأعلى</th>
                                                                <th class="text-center">الحد الأدنى</th>
                                                                <th class="text-center">النتيجة</th>
                                                                <th class="text-center">الحالة</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <t t-foreach="computed_lines.sorted('id')" t-as="line">
                                                                <t t-set="min_limit" t-value="line.criterion_id.min_value if line.criterion_id.min_value else 0"/>
                                                                <t t-set="max_limit" t-value="line.criterion_id.max_value if line.criterion_id.max_value else 100"/>
                                                                <t t-set="value" t-value="line.value_numeric or 0"/>
                                                                <t t-set="is_compliant" t-value="min_limit &lt;= value and value &lt;= max_limit"/>
                                                                <tr>
                                                                    <td>
                                                                        <t t-set="sample_code" t-value="'عينة ' + str(line.sample_no) if line.sample_no else ''"/>
                                                                        <strong>
                                                                            <t t-if="sample_code">
                                                                                <span class="badge badge-secondary me-1" t-esc="sample_code"/>
                                                                            </t>
                                                                            <span t-esc="line.criterion_id.name"/>
                                                                        </strong>
                                                                        <br/>
                                                                        <small class="text-muted">(<span t-esc="line.criterion_id.code"/>)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="line.criterion_id.uom_id">
                                                                            <span t-esc="line.criterion_id.uom_id.name"/>
                                                                        </t>
                                                                        <t t-else="">-</t>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-success"><span t-esc="round(max_limit, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-danger"><span t-esc="round(min_limit, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-primary"><span t-esc="round(value, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="is_compliant">
                                                                            <span class="badge badge-success">مطابق</span>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <span class="badge badge-danger">غير مطابق</span>
                                                                        </t>
                                                                    </td>
                                                                </tr>
                                                            </t>
                                                        </tbody>
                                                    </table>
                                                </t>
                                                </div>
                                            </t>

                                            <t t-elif="'COMP' in (result_set.template_id.code or '') and 'BRICK' in (result_set.template_id.code or '')">

                                                <t t-set="sample_count" t-value="len(set(result_set.result_line_ids.mapped('sample_no')))"/>
                                                <h4><span t-field="result_set.template_id.name"/> (<t t-esc="sample_count"/>) 
                                                    <small class="text-muted">(<span t-field="result_set.template_id.code"/>)</small>
                                                </h4>                              

                                                <div class="mb16">
                                                    <p class="text-muted">
                                                        <strong>تاريخ الفحص:</strong> <span t-field="result_set.testing_date"/>
                                                        <t t-if="result_set.technician_id">
                                                            | <strong>الفني:</strong> <span t-field="result_set.technician_id.name"/>
                                                        </t>
                                                    </p>
                                                </div>

                                                <t t-set="non_computed_lines" t-value="result_set.result_line_ids.filtered(lambda x: 'COMP_STRENGTH' in x.criterion_id.code or 'INDIVIDUAL_COMP_STRENGTH' in x.criterion_id.code)"/>
                                                <t t-if="non_computed_lines">
                                                    <t t-set="direct_sample_count" t-value="len(non_computed_lines)"/>
                                                    <h6 class="text-muted mb-2">القياسات المباشرة (<t t-esc="direct_sample_count"/>):</h6>
                                                    <table class="table table-bordered table-sm mb-3">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th class="text-center">المعيار</th>
                                                                <th class="text-center">الوحدة</th>
                                                                <th class="text-center">الحد الأعلى</th>
                                                                <th class="text-center">الحد الأدنى</th>
                                                                <th class="text-center">النتيجة</th>
                                                                <th class="text-center">الحالة</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <t t-foreach="non_computed_lines.sorted('id')" t-as="line">
                                                                <t t-set="min_limit" t-value="line.criterion_id.min_value if line.criterion_id.min_value else 0"/>
                                                                <t t-set="max_limit" t-value="line.criterion_id.max_value if line.criterion_id.max_value else 9999"/>
                                                                <t t-set="value" t-value="line.value_numeric or 0"/>
                                                                <t t-set="is_compliant" t-value="min_limit &lt;= value and value &lt;= max_limit"/>
                                                                <tr>
                                                                    <td>
                                                                        <t t-set="sample_code" t-value="'عينة ' + str(line.sample_no) if line.sample_no else ''"/>
                                                                        <strong>
                                                                            <t t-if="sample_code">
                                                                                <span class="badge badge-secondary me-1" t-esc="sample_code"/>
                                                                            </t>
                                                                            <span t-esc="line.criterion_id.name"/>
                                                                        </strong>
                                                                        <br/>
                                                                        <small class="text-muted">(<span t-esc="line.criterion_id.code"/>)</small>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="line.criterion_id.uom_id">
                                                                            <span t-esc="line.criterion_id.uom_id.name"/>
                                                                        </t>
                                                                        <t t-else="">-</t>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-success"><span t-esc="round(max_limit, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-danger"><span t-esc="round(min_limit, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <strong class="text-primary"><span t-esc="round(value, 2)"/></strong>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <t t-if="is_compliant">
                                                                            <span class="badge badge-success">مطابق</span>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <span class="badge badge-danger">غير مطابق</span>
                                                                        </t>
                                                                    </td>
                                                                </tr>
                                                            </t>
                                                        </tbody>
                                                    </table>
                                                </t>
                                                
                                            <t t-if="not ('COMP' in (result_set.template_id.code or '') and 'BRICK' in (result_set.template_id.code or ''))">
                                                <t t-set="sample_count" t-value="len(set(result_set.result_line_ids.mapped('sample_no')))"/>
                                                <h4><span t-field="result_set.template_id.name"/> (<t t-esc="sample_count"/>) 
                                                    <small class="text-muted">(<span t-field="result_set.template_id.code"/>)</small>
                                                </h4>                              

                                                <div class="mb16">
                                                    <p class="text-muted">
                                                        <strong>تاريخ الفحص:</strong> <span t-field="result_set.testing_date"/>
                                                        <t t-if="result_set.technician_id">
                                                            | <strong>الفني:</strong> <span t-field="result_set.technician_id.name"/>
                                                        </t>
                                                    </p>
                                                </div>
                                                <table class="table table-bordered table-sm">
                                                    <thead class="table-active">
                                                        <tr>
                                                            <th class="text-center">المعيار</th>
                                                            <th class="text-center">رقم العينة</th>
                                                            <th class="text-center">القيمة الرقمية</th>
                                                            <th class="text-center">القيمة النصية</th>
                                                            <th class="text-center">الاختيار</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="result_set.result_line_ids.filtered(lambda x: 'COMP_STRENGTH' not in x.criterion_id.code and 'INDIVIDUAL_COMP_STRENGTH' not in x.criterion_id.code).sorted('id')" t-as="line">
                                                        <tr>
                                                            <td>
                                                                <strong><span t-field="line.criterion_id.name"/></strong>
                                                                <br/>
                                                                <small class="text-muted">(<span t-field="line.criterion_id.code"/>)</small>
                                                                <t t-if="line.criterion_id.uom_id">
                                                                    <br/>
                                                                    <small class="text-info">الوحدة: <span t-field="line.criterion_id.uom_id.name"/></small>
                                                                </t>
                                                            </td>
                                                            <td class="text-center">
                                                                <span t-field="line.sample_no"/>
                                                            </td>
                                                            <td class="text-center">
                                                                <t t-if="line.value_numeric">
                                                                    <span t-field="line.value_numeric"/>
                                                                </t>
                                                                <t t-else="">-</t>
                                                            </td>
                                                            <td class="text-center">
                                                                <t t-if="line.value_text">
                                                                    <span t-field="line.value_text"/>
                                                                </t>
                                                                <t t-else="">-</t>
                                                            </td>
                                                            <td class="text-center">
                                                                <t t-if="line.value_selection">
                                                                    <span t-field="line.value_selection"/>
                                                                </t>
                                                                <t t-else="">-</t>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                    </tbody>
                                                </table>
                                            </t>
                                        </t>
                                        <t t-else="">
                                            <div class="alert alert-info">
                                                <p>لا توجد نتائج مدخلة لهذا الفحص</p>
                                            </div>
                                        </t>
                                    </t>
                                </div>
                            </t>
                        </t>
                        <t t-else="">
                            <div class="lab-section">
                                <div class="alert alert-warning text-center">
                                    <h4>لا توجد نتائج فحوصات لهذه العينة</h4>
                                    <p>لم يتم إدخال أي نتائج فحوصات لهذه العينة حتى الآن.</p>
                                </div>
                            </div>
                        </t>

                        <!-- قسم الملاحظات -->
                        <t t-if="doc.notes">
                            <div class="lab-section" style="page-break-inside: avoid;">
                                <h3>الملاحظات</h3>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <div style="font-size: 14px; line-height: 1.6; font-family: 'tradbdo', Arial, sans-serif;" t-field="doc.notes"/>
                                </div>
                            </div>
                        </t>

                        <div class="row mt32">
                            <div class="col-12">
                                <hr/>
                                <p class="text-center text-muted">
                                    <small>     </small>
                                </p>
                            </div>
                        </div>

                        <!-- قسم التوقيعات -->
                        <div class="row mt-4" style="page-break-inside: avoid;">
                            <div class="col-12">
                                <h4 style="color: #667eea; margin-bottom: 20px; text-align: center; font-weight: bold;">التوقيعات</h4>
                                <div style="padding-bottom:4px;margin-bottom:4px;">
                                    <table style="width:100%;border-collapse:collapse;direction:rtl;">
                                        <tr>
                                            <td style="width:33.33%;text-align:center;padding:15px;border:1px solid #c0d6e4;border-radius:8px;background:#ffffff;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                                <div style="margin-bottom:8px;">
                                                    <strong>مسؤول الوحدة</strong>
                                                </div>
                                                <t t-if="doc.exec_signature">
                                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;display:flex;align-items:center;justify-content:center;">
                                                        <img t-att-src="image_data_uri(doc.exec_signature)" style="max-width:100%;max-height:100%;"/>
                                                    </div>
                                                    <div style="font-size:12px;"><t t-esc="doc.exec_signer_name or ''"/></div>
                                                </t>
                                                <t t-else="">
                                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;"/>
                                                    <div style="font-size:12px;">الاسم/ ____________</div>
                                                </t>
                                            </td>
                                            <td style="width:10px;"></td>
                                            <td style="width:33.33%;text-align:center;padding:15px;border:1px solid #c0d6e4;border-radius:8px;background:#ffffff;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                                <div style="margin-bottom:8px;">
                                                    <strong>مسؤول الجودة</strong>
                                                </div>
                                                <t t-if="doc.super_signature">
                                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;display:flex;align-items:center;justify-content:center;">
                                                        <img t-att-src="image_data_uri(doc.super_signature)" style="max-width:100%;max-height:100%;"/>
                                                    </div>
                                                    <div style="font-size:12px;"><t t-esc="doc.super_signer_name or ''"/></div>
                                                </t>
                                                <t t-else="">
                                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;"/>
                                                    <div style="font-size:12px;">الاسم/ ____________</div>
                                                </t>
                                            </td>
                                            <td style="width:10px;"></td>
                                            <td style="width:33.33%;text-align:center;padding:15px;border:1px solid #c0d6e4;border-radius:8px;background:#ffffff;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                                <div style="margin-bottom:8px;">
                                                    <strong>المدير التنفيذي</strong>
                                                </div>
                                                <t t-if="doc.company_signature">
                                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;display:flex;align-items:center;justify-content:center;">
                                                        <img t-att-src="image_data_uri(doc.company_signature)" style="max-width:100%;max-height:100%;"/>
                                                    </div>
                                                    <div style="font-size:12px;"><t t-esc="doc.company_signer_name or ''"/></div>
                                                </t>
                                                <t t-else="">
                                                    <div style="height:80px;border:1px solid #ddd;margin:10px 0;"/>
                                                    <div style="font-size:12px;">الاسم/ ____________</div>
                                                </t>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="oe_structure"/>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
