<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <record id="view_business_process_tree" model="ir.ui.view">
            <field name="name">business.process.tree</field>
            <field name="model">business.process</field>
            <field name="type">list</field>
            <field name="arch" type="xml">
                <list string="العمليات " decoration-success="state=='active'" decoration-muted="state=='archived'" decoration-warning="state=='testing'">
                    <field name="sequence" widget="handle"/>
                    <field name="name"/>
                    <field name="process_type"/>
                    <field name="priority" widget="priority"/>
                    <field name="state" widget="badge" decoration-success="state=='active'" decoration-warning="state=='testing'" decoration-danger="state=='deprecated'"/>
                    <field name="instance_count"/>
                    <field name="success_rate" widget="progressbar"/>
                    <field name="owner_id"/>
                    <field name="company_id" groups="base.group_multi_company"/>
                </list>
            </field>
        </record>
        

        <record id="view_business_process_form" model="ir.ui.view">
            <field name="name">business.process.form</field>
            <field name="model">business.process</field>
            <field name="arch" type="xml">
                <form string="العملية">
                    <header>
                        <button name="action_activate" string="تفعيل" type="object" 
                                class="oe_highlight" invisible="state != 'draft'"/>
                        <button name="action_deactivate" string="إلغاء التفعيل" type="object" 
                                invisible="state != 'active'"/>
                        <button name="action_test_process" string="اختبار العملية" type="object" 
                                class="btn-secondary" invisible="step_count == 0"/>
                        <button name="action_view_instances" string="عرض نسخ التنفيذ" type="object" 
                                class="btn-secondary" invisible="instance_count == 0"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,active,testing,deprecated"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_instances" type="object" class="oe_stat_button" icon="fa-cogs">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_value"><field name="instance_count" widget="statinfo" string="نسخ التنفيذ"/></span>
                                    <button class="o_stat_button">نسخ التنفيذ</button>
                                </div>
                            </button>
                            <button name="action_view_statistics" type="object" class="oe_stat_button" icon="fa-bar-chart">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_value"><field name="success_rate"/>%</span>
                                    <button class="o_stat_button">معدل النجاح</button>
                                </div>
                            </button>
                        </div>
                        
                        <widget name="web_ribbon" title="مؤرشف" bg_color="bg-danger" 
                                invisible="state != 'archived'"/>
                        <widget name="web_ribbon" title="قيد الاختبار" bg_color="bg-warning" 
                                invisible="state != 'testing'"/>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="اسم العملية "/>
                            </h1>
                            <div class="o_row">
                                <field name="code" placeholder="رمز العملية"/>
                            </div>
                        </div>
                        
                        <group>
                            <group name="basic_info">
                                <field name="process_type"/>
                                <field name="priority" widget="priority"/>
                                <field name="sequence"/>
                                <field name="active"/>
                            </group>
                            <group name="sla_info">
                                <field name="expected_duration" widget="float_time"/>
                                <field name="escalation_threshold" widget="float_time"/>
                                <field name="average_completion_time" widget="float_time" readonly="1"/>
                                <field name="company_id" groups="base.group_multi_company"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="وصف العملية" name="description">
                                <field name="description" placeholder="وصف تفصيلي للعملية وأهدافها"/>
                            </page>
                            
                            <page string="نطاق التطبيق" name="scope">
                                <group>
                                    <field name="applicable_to"/>
                                    <field name="applicable_category_ids" widget="many2many_tags" 
                                           invisible="applicable_to != 'specific_categories'"/>
                                    <field name="applicable_department_ids" widget="many2many_tags" 
                                           invisible="applicable_to != 'specific_departments'"/>
                                    <field name="auto_trigger"/>
                                    <field name="trigger_condition" invisible="auto_trigger == False"
                                           placeholder="{'document_type': 'incoming'}"/>
                                </group>
                            </page>
                            
                            <page string="خطوات العملية" name="steps">
                                <field name="step_ids">
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="name"/>
                                        <field name="step_type"/>
                                        <field name="responsible_type"/>
                                        <field name="responsible_department_id" 
                                               invisible="responsible_type != 'department'"/>
                                        <field name="responsible_employee_id" 
                                               invisible="responsible_type != 'specific_employee'"/>
                                        <field name="max_duration" widget="float_time"/>
                                        <field name="is_mandatory"/>
                                        <field name="active"/>
                                    </list>
                                </field>
                                <div class="oe_clear"/>
                                <group>
                                    <field name="step_count" readonly="1"/>
                                </group>
                            </page>
                            
                            <page string="المسؤولون" name="responsibility">
                                <group>
                                    <field name="owner_id"/>
                                    <field name="manager_ids" widget="many2many_tags"/>
                                </group>
                            </page>
                            
                            <page string="إعدادات متقدمة" name="advanced">
                                <group>
                                    <group>
                                        <field name="allow_skip_steps"/>
                                        <field name="require_notes"/>
                                        <field name="notification_enabled"/>
                                    </group>
                                </group>
                            </page>
                            
                            <page string="الإحصائيات" name="statistics" invisible="instance_count == 0">
                                <group>
                                    <group>
                                        <field name="instance_count" readonly="1"/>
                                        <field name="success_rate" widget="progressbar" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="average_completion_time" widget="float_time" readonly="1"/>
                                        <field name="expected_duration" widget="float_time" readonly="1"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>
        

        <record id="view_business_process_kanban" model="ir.ui.view">
            <field name="name">business.process.kanban</field>
            <field name="model">business.process</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" default_order="priority desc, success_rate desc, name asc"
                        class="o_kanban_wide_column o_document_kanban o_business_process_kanban"
                        quick_create="false" create="true"
                        records_draggable="false" groups_draggable="false">
                    <field name="id"/>
                    <field name="name"/>
                    <field name="code"/>
                    <field name="process_type"/>
                    <field name="state"/>
                    <field name="priority"/>
                    <field name="instance_count"/>
                    <field name="success_rate"/>
                    <field name="average_completion_time"/>
                    <field name="expected_duration"/>
                    <field name="owner_id"/>
                    <field name="step_count"/>
                    <field name="create_date"/>
                    <field name="activity_ids"/>
                    <field name="activity_state"/>
                    
                    <progressbar field="activity_state" 
                               colors='{"planned": "success", "today": "warning", "overdue": "danger"}'
                               help="شريط التقدم يظهر حالة الأنشطة المجدولة للعمليات"/>
                    
                    <templates>
                        <t t-name="kanban-box">
                            <div class="o_kanban_card o_kanban_global_click o_document_card o_business_process_card" 
                                 t-attf-class="#{record.state.raw_value === 'active' ? 'o_card_active' : record.state.raw_value === 'testing' ? 'o_card_testing' : 'o_card_inactive'} #{record.priority.raw_value == '3' ? 'o_card_featured' : ''}"
                                 t-attf-data-state="#{record.state.raw_value}"
                                 t-attf-data-priority="#{record.priority.raw_value}">
                                
                                <div class="o_kanban_card_header">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_top_left">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge me-2" 
                                                      t-attf-class="#{record.state.raw_value === 'active' ? 'badge-success' : record.state.raw_value === 'testing' ? 'badge-warning' : 'badge-secondary'}">
                                                    <i class="fa fa-play me-1" t-if="record.state.raw_value === 'active'"/>
                                                    <i class="fa fa-flask me-1" t-if="record.state.raw_value === 'testing'"/>
                                                    <i class="fa fa-pause me-1" t-if="record.state.raw_value === 'deprecated'"/>
                                                    <i class="fa fa-file-o me-1" t-if="record.state.raw_value === 'draft'"/>
                                                    <t t-esc="record.state.value"/>
                                                </span>
                                                <span class="badge badge-info ms-1" t-if="record.priority.raw_value > 1">
                                                    <field name="priority" widget="priority"/>
                                                </span>
                                            </div>
                                            <strong class="o_kanban_record_title">
                                                <field name="name"/>
                                            </strong>
                                            <div class="o_kanban_record_subtitle text-muted" t-if="record.code.raw_value">
                                                <i class="fa fa-code me-1"/>
                                                <field name="code"/>
                                            </div>
                                        </div>
                                        <div class="o_kanban_top_right">
                                            <div class="o_dropdown_kanban dropdown">
                                                <a role="button" class="dropdown-toggle o-no-caret btn" data-bs-toggle="dropdown" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                                    <span class="fa fa-ellipsis-v"/>
                                                </a>
                                                <div class="dropdown-menu" role="menu">
                                                    <a role="menuitem" class="dropdown-item oe_kanban_action oe_kanban_action_a" type="open">
                                                        <i class="fa fa-external-link me-2"/>عرض العملية
                                                    </a>
                                                    <a role="menuitem" class="dropdown-item oe_kanban_action oe_kanban_action_a" type="edit">
                                                        <i class="fa fa-edit me-2"/>تحرير
                                                    </a>
                                                    <div class="dropdown-divider"/>
                                                    <t t-if="widget.deletable">
                                                        <a role="menuitem" class="dropdown-item oe_kanban_action oe_kanban_action_a" type="delete">
                                                            <i class="fa fa-trash me-2"/>حذف
                                                        </a>
                                                    </t>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_card_content">
                                    <div class="o_kanban_tags_section mb-3">
                                        <div class="d-flex flex-wrap gap-1">
                                            <span class="o_kanban_tag o_kanban_tag_type" t-if="record.process_type.raw_value">
                                                <i class="fa fa-cogs me-1"/>
                                                <field name="process_type"/>
                                            </span>
                                        </div>
                                    </div>
                                    

                                    <div class="o_kanban_stats_section mb-3">
                                        <div class="row">
                                            <div class="col-4 text-center">
                                                <div class="o_kanban_statistic">
                                                    <span class="o_kanban_stat_value"><t t-esc="record.step_count.value"/></span>
                                                    <small class="o_kanban_stat_label">خطوة</small>
                                                </div>
                                            </div>
                                            <div class="col-4 text-center">
                                                <div class="o_kanban_statistic">
                                                    <span class="o_kanban_stat_value"><t t-esc="record.instance_count.value"/></span>
                                                    <small class="o_kanban_stat_label">تنفيذ</small>
                                                </div>
                                            </div>
                                            <div class="col-4 text-center">
                                                <div class="o_kanban_statistic">
                                                    <span class="o_kanban_stat_value"><t t-esc="record.success_rate.value"/>%</span>
                                                    <small class="o_kanban_stat_label">نجاح</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    

                                    <div class="o_kanban_success_section mb-3" t-if="record.success_rate.raw_value > 0">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted d-flex align-items-center">
                                                <i class="fa fa-chart-line me-1"/>
                                                معدل النجاح
                                            </small>
                                            <small class="fw-bold" 
                                                   t-attf-class="#{record.success_rate.raw_value >= 90 ? 'text-success' : record.success_rate.raw_value >= 70 ? 'text-warning' : 'text-danger'}">
                                                <t t-esc="record.success_rate.value"/>%
                                            </small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 t-attf-class="#{record.success_rate.raw_value >= 90 ? 'bg-success' : record.success_rate.raw_value >= 70 ? 'bg-warning' : 'bg-danger'}"
                                                 t-attf-style="width: #{record.success_rate.value}%"
                                                 t-attf-aria-valuenow="#{record.success_rate.value}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                    </div>
                                    

                                    <div class="o_kanban_details_section mb-3" t-if="record.average_completion_time.raw_value > 0">
                                        <div class="o_kanban_detail_row">
                                            <span class="o_kanban_detail_label">
                                                <i class="fa fa-clock-o me-1"/>
                                                متوسط الإنجاز
                                            </span>
                                            <span class="o_kanban_detail_value">
                                                <field name="average_completion_time" widget="float_time"/> ساعة
                                            </span>
                                        </div>
                                        <div class="o_kanban_detail_row" t-if="record.expected_duration.raw_value > 0">
                                            <span class="o_kanban_detail_label">
                                                <i class="fa fa-target me-1"/>
                                                المدة المتوقعة
                                            </span>
                                            <span class="o_kanban_detail_value">
                                                <field name="expected_duration" widget="float_time"/> ساعة
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_card_footer">
                                    <div class="o_kanban_footer_left">
                                        <div class="o_kanban_footer_stats">
                                            <span class="o_kanban_stats_item" t-if="record.instance_count.raw_value > 0">
                                                <i class="fa fa-refresh me-1"/>
                                                <t t-esc="record.instance_count.value"/>
                                                <small class="text-muted">تنفيذ</small>
                                            </span>
                                            <span class="o_kanban_stats_item" t-if="record.step_count.raw_value > 0">
                                                <i class="fa fa-list-ol me-1"/>
                                                <t t-esc="record.step_count.value"/>
                                                <small class="text-muted">خطوة</small>
                                            </span>
                                        </div>
                                        <div class="o_kanban_footer_activity">
                                            <field name="activity_ids" widget="kanban_activity"/>
                                        </div>
                                    </div>
                                    <div class="o_kanban_footer_right">
                                        <div class="o_kanban_footer_meta">
                                            <small class="text-muted" t-if="record.owner_id.raw_value">
                                                <i class="fa fa-user me-1"/>
                                                <field name="owner_id"/>
                                            </small>
                                        </div>
                                        <div class="o_kanban_click_indicator">
                                            <i class="fa fa-external-link text-primary" title="عرض التفاصيل"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>
        

        <record id="view_business_process_search" model="ir.ui.view">
            <field name="name">business.process.search</field>
            <field name="model">business.process</field>
            <field name="arch" type="xml">
                <search string="البحث في العمليات ">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="process_type"/>
                    <field name="owner_id"/>
                    <field name="manager_ids"/>
                    <filter string="العمليات النشطة" name="active_processes" domain="[('state', '=', 'active')]"/>
                    <filter string="قيد الاختبار" name="testing_processes" domain="[('state', '=', 'testing')]"/>
                    <filter string="عملياتي" name="my_processes" domain="[('owner_id.user_id', '=', uid)]"/>
                    <separator/>
                    <group expand="1" string="تجميع حسب">
                        <filter string="الحالة" name="group_by_state" context="{'group_by': 'state'}"/>
                        <filter string="نوع العملية" name="group_by_type" context="{'group_by': 'process_type'}"/>
                        <filter string="المالك" name="group_by_owner" context="{'group_by': 'owner_id'}"/>
                    </group>
                </search>
            </field>
        </record>
        

        
        <record id="view_workflow_instance_tree" model="ir.ui.view">
            <field name="name">document.workflow.instance.tree</field>
            <field name="model">document.workflow.instance</field>
            <field name="type">list</field>
            <field name="arch" type="xml">
                <list string="نسخ سير العمل" decoration-success="state=='completed'" decoration-danger="state=='failed'" decoration-warning="state=='waiting'" decoration-info="state=='running'">
                    <field name="name"/>
                    <field name="business_process_id"/>
                    <field name="document_id"/>
                    <field name="state" widget="badge"/>
                    <field name="current_step_name"/>
                    <field name="progress_percentage" widget="progressbar"/>
                    <field name="priority" widget="priority"/>
                    <field name="start_date" widget="datetime"/>
                    <field name="due_date" widget="datetime"/>
                    <field name="is_overdue" invisible="1"/>
                    <field name="is_test" invisible="1"/>
                    <field name="responsible_department_id"/>
                    <field name="initiator_id"/>
                </list>
            </field>
        </record>
        

        <record id="view_workflow_instance_form" model="ir.ui.view">
            <field name="name">document.workflow.instance.form</field>
            <field name="model">document.workflow.instance</field>
            <field name="arch" type="xml">
                <form string="نسخة سير العمل">
                    <header>
                        <button name="action_start" string="بدء التنفيذ" type="object" 
                                class="oe_highlight" invisible="state != 'initiated'"/>
                        <button name="action_complete" string="إكمال العملية" type="object" 
                                class="oe_highlight" invisible="state != 'running'"/>
                        <button name="action_suspend" string="تعليق" type="object" 
                                invisible="state not in ['running', 'waiting']"/>
                        <button name="action_resume" string="استئناف" type="object" 
                                class="oe_highlight" invisible="state != 'suspended'"/>
                        <button name="action_cancel" string="إلغاء" type="object" 
                                invisible="state in ['completed', 'cancelled']"/>
                        <button name="action_escalate" string="تصعيد" type="object" 
                                class="btn-warning" invisible="state != 'running'"/>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_document" type="object" class="oe_stat_button" icon="fa-file-text-o" 
                                    invisible="document_id == False">
                                <div class="o_field_widget o_stat_info">
                                    <button class="o_stat_button">الوثيقة</button>
                                </div>
                            </button>
                            <button name="action_view_tasks" type="object" class="oe_stat_button" icon="fa-tasks">
                                <field name="active_tasks_count" widget="statinfo" string="مهام نشطة"/>
                            </button>
                            <button name="action_view_step_history" type="object" class="oe_stat_button" icon="fa-history">
                                <field name="completed_steps_count" widget="statinfo" string="خطوات مكتملة"/>
                            </button>
                        </div>
                        
                        <widget name="web_ribbon" title="اختبار" bg_color="bg-info" 
                                invisible="is_test == False"/>
                        <widget name="web_ribbon" title="متأخر" bg_color="bg-danger" 
                                invisible="is_overdue == False"/>
                        <widget name="web_ribbon" title="مُصعد" bg_color="bg-warning" 
                                invisible="is_escalated == False"/>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name"/>
                            </h1>
                            <div class="o_row">
                                <field name="instance_id" readonly="1"/>
                            </div>
                        </div>
                        
                        <group>
                            <group name="process_info">
                                <field name="business_process_id"/>
                                <field name="document_id"/>
                                <field name="current_step_name" readonly="1"/>
                                <field name="progress_percentage" widget="progressbar" readonly="1"/>
                            </group>
                            <group name="timing_info">
                                <field name="priority" widget="priority"/>
                                <field name="start_date" readonly="1"/>
                                <field name="due_date" readonly="1"/>
                                <field name="completion_date" readonly="1" invisible="state != 'completed'"/>
                                <field name="actual_duration" widget="float_time" readonly="1" 
                                       invisible="state != 'completed'"/>
                            </group>
                        </group>
                        
                        <group>
                            <group name="responsibility">
                                <field name="initiator_id"/>
                                <field name="responsible_department_id"/>
                            </group>
                            <group name="status_info">
                                <field name="is_overdue" readonly="1"/>
                                <field name="is_escalated" readonly="1"/>
                                <field name="escalation_date" readonly="1" invisible="is_escalated == False"/>
                                <field name="efficiency_rating" widget="progressbar" readonly="1" 
                                       invisible="state != 'completed'"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="سجل تنفيذ الخطوات" name="step_history">
                                <field name="step_history_ids">
                                    <list>
                                        <field name="step_id"/>
                                        <field name="state" widget="badge"/>
                                        <field name="start_date" widget="datetime"/>
                                        <field name="completion_date" widget="datetime"/>
                                        <field name="duration_hours" widget="float_time"/>
                                        <field name="admin_task_id"/>
                                    </list>
                                </field>
                            </page>
                            
                            <page string="المهام المرتبطة" name="tasks">
                                <field name="admin_task_ids">
                                    <list>
                                        <field name="name"/>
                                        <field name="task_type"/>
                                        <field name="assigned_employee_id"/>
                                        <field name="state" widget="badge"/>
                                        <field name="priority" widget="priority"/>
                                        <field name="due_date" widget="datetime"/>
                                    </list>
                                </field>
                            </page>
                            
                            <page string="بيانات التنفيذ" name="execution_data">
                                <group>
                                    <field name="trigger_data" readonly="1"/>
                                    <field name="execution_context" readonly="1"/>
                                </group>
                            </page>
                            
                            <page string="النتائج والتقييم" name="results" invisible="state != 'completed'">
                                <group>
                                    <field name="result_summary"/>
                                    <field name="success_level"/>
                                    <field name="escalation_reason" invisible="is_escalated == False"/>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>
        

        <record id="view_workflow_instance_search" model="ir.ui.view">
            <field name="name">document.workflow.instance.search</field>
            <field name="model">document.workflow.instance</field>
            <field name="arch" type="xml">
                <search string="البحث في نسخ سير العمل">
                    <field name="name"/>
                    <field name="instance_id"/>
                    <field name="business_process_id"/>
                    <field name="document_id"/>
                    <field name="initiator_id"/>
                    <filter string="قيد التنفيذ" name="running" domain="[('state', '=', 'running')]"/>
                    <filter string="مكتملة" name="completed" domain="[('state', '=', 'completed')]"/>
                    <filter string="متأخرة" name="overdue" domain="[('is_overdue', '=', True)]"/>
                    <filter string="مُصعدة" name="escalated" domain="[('is_escalated', '=', True)]"/>
                    <filter string="نسخ اختبار" name="test_instances" domain="[('is_test', '=', True)]"/>
                    <separator/>
                    <filter string="العمليات الخاصة بي" name="my_instances" 
                            domain="[('initiator_id.user_id', '=', uid)]"/>
                    <group expand="1" string="تجميع حسب">
                        <filter string="الحالة" name="group_by_state" context="{'group_by': 'state'}"/>
                        <filter string="العملية" name="group_by_process" context="{'group_by': 'business_process_id'}"/>
                        <filter string="المبادر" name="group_by_initiator" context="{'group_by': 'initiator_id'}"/>
                        <filter string="القسم المسؤول" name="group_by_department" context="{'group_by': 'responsible_department_id'}"/>
                    </group>
                </search>
            </field>
        </record>
        
    </data>
</odoo>