<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="workflow_process_tree_view" model="ir.ui.view">
        <field name="name">workflow.process.tree</field>
        <field name="model">workflow.process</field>
        <field name="arch" type="xml">
            <list decoration-muted="state=='archived'" decoration-info="state=='active'" decoration-warning="state=='testing'">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="category"/>
                <field name="process_type"/>
                <field name="priority" widget="priority"/>
                <field name="step_count"/>
                <field name="instance_count"/>
                <field name="success_rate" widget="progressbar"/>
                <field name="state" widget="badge" decoration-success="state=='active'" decoration-warning="state=='testing'" decoration-muted="state=='archived'"/>
                <field name="active" invisible="1"/>
            </list>
        </field>
    </record>
    <record id="workflow_process_form_view" model="ir.ui.view">
        <field name="name">workflow.process.form</field>
        <field name="model">workflow.process</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_activate" string="تفعيل" type="object" invisible="state not in ('draft', 'testing')" class="btn-primary"/>
                    <button name="action_test" string="اختبار" type="object" invisible="state not in ('draft', 'active')" class="btn-warning"/>
                    <button name="action_deprecate" string="عزل" type="object" invisible="state not in ('active', 'testing')"/>
                    <button name="action_archive_process" string="أرشفة" type="object" invisible="state != 'deprecated'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,testing,active,deprecated"/>
                </header>
                
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" name="action_view_instances" icon="fa-play">
                            <field name="instance_count" widget="statinfo" string="مرات التنفيذ"/>
                        </button>
                        
                        <button class="oe_stat_button" type="object" name="action_view_steps" icon="fa-list-ol">
                            <field name="step_count" widget="statinfo" string="عدد الخطوات"/>
                        </button>
                    </div>
                    
                    <widget name="web_ribbon" title="نشط" bg_color="bg-success" invisible="state != 'active'"/>
                    <widget name="web_ribbon" title="مؤرشف" bg_color="bg-secondary" invisible="state != 'archived'"/>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="اسم العملية"/>
                        </h1>
                        <h2 invisible="not code">
                            <field name="code" placeholder="رمز العملية"/>
                        </h2>
                    </div>
                    
                    <group>
                        <group>
                            <field name="category"/>
                            <field name="process_type"/>
                            <field name="priority" widget="priority"/>
                            <field name="sequence"/>
                            <field name="active"/>
                        </group>
                        <group>
                            <field name="owner_id"/>
                            <field name="sla_hours"/>
                            <field name="success_rate" widget="progressbar"/>
                            <field name="average_completion_time"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="الوصف والإعدادات">
                            <group>
                                <field name="description" nolabel="1" placeholder="وصف تفصيلي للعملية..."/>
                            </group>
                            
                            <group string="نطاق التطبيق">
                                <field name="applicable_to"/>
                                <field name="applicable_category_ids" widget="many2many_tags" invisible="applicable_to != 'specific_categories'"/>
                                <field name="applicable_department_ids" widget="many2many_tags" invisible="applicable_to != 'specific_departments'"/>
                            </group>
                            
                            <group string="شروط التفعيل">
                                <field name="auto_trigger"/>
                                <field name="trigger_conditions" placeholder='{"priority": "high", "category": "urgent"}' invisible="not auto_trigger"/>
                            </group>
                        </page>
                        
                        <page string="خطوات العملية">
                            <field name="step_ids" nolabel="1">
                                <list editable="bottom">
                                    <field name="sequence" widget="handle"/>
                                    <field name="name"/>
                                    <field name="step_type"/>
                                    <field name="responsible_type"/>
                                    <field name="responsible_user_id" invisible="responsible_type != 'specific_user'"/>
                                    <field name="responsible_department_id" invisible="responsible_type != 'department'"/>
                                    <field name="estimated_hours"/>
                                    <field name="is_mandatory"/>
                                    <field name="active"/>
                                </list>
                                <form>
                                    <group>
                                        <group>
                                            <field name="name"/>
                                            <field name="step_type"/>
                                            <field name="sequence"/>
                                            <field name="is_mandatory"/>
                                            <field name="requires_approval"/>
                                        </group>
                                        <group>
                                            <field name="responsible_type"/>
                                            <field name="responsible_user_id" invisible="responsible_type != 'specific_user'"/>
                                            <field name="responsible_department_id" invisible="responsible_type != 'department'"/>
                                            <field name="responsible_role" invisible="responsible_type != 'role'"/>
                                        </group>
                                    </group>
                                    
                                    <group>
                                        <field name="description" nolabel="1" placeholder="تعليمات تفصيلية..."/>
                                    </group>
                                    
                                    <group string="التوقيتات والشروط">
                                        <group>
                                            <field name="estimated_hours"/>
                                            <field name="deadline_hours"/>
                                        </group>
                                        <group>
                                            <field name="send_notification"/>
                                            <field name="notification_template_id" invisible="not send_notification"/>
                                        </group>
                                    </group>
                                    
                                    <group string="الشروط">
                                        <field name="required_conditions" placeholder="الشروط المطلوبة لتنفيذ الخطوة"/>
                                        <field name="skip_conditions" placeholder="الشروط التي تسمح بتخطي الخطوة"/>
                                    </group>
                                    
                                    <group string="الخطوات التالية">
                                        <field name="next_step_ids" widget="many2many_tags"/>
                                    </group>
                                </form>
                            </field>
                        </page>
                        
                        <page string="الإدارة والصلاحيات">
                            <group>
                                <field name="manager_ids" widget="many2many_tags"/>
                            </group>
                            
                            <group string="إعدادات متقدمة">
                                <field name="allow_skip_steps"/>
                                <field name="require_notes"/>
                                <field name="notification_enabled"/>
                            </group>
                        </page>
                        
                        <page string="الإحصائيات والأداء">
                            <group>
                                <group>
                                    <field name="instance_count" readonly="1"/>
                                    <field name="success_rate" widget="progressbar" readonly="1"/>
                                </group>
                                <group>
                                    <field name="average_completion_time" readonly="1"/>
                                    <field name="sla_hours"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                
                <chatter/>
            </form>
        </field>
    </record>

    <record id="workflow_process_kanban_view" model="ir.ui.view">
        <field name="name">workflow.process.kanban</field>
        <field name="model">workflow.process</field>
        <field name="arch" type="xml">
            <kanban default_group_by="category" default_order="priority desc, name asc"
                    class="o_kanban_wide_column o_document_kanban o_workflow_kanban"
                    quick_create="false" create="true"
                    records_draggable="false" groups_draggable="false">
                <field name="id"/>
                <field name="name"/>
                <field name="category"/>
                <field name="state"/>
                <field name="step_count"/>
                <field name="instance_count"/>
                <field name="success_rate"/>
                <field name="code"/>
                <field name="description"/>
                <field name="create_date"/>
                <field name="write_date"/>
                <field name="activity_ids"/>
                <field name="activity_state"/>
                
                <progressbar field="activity_state" 
                           colors='{"planned": "success", "today": "warning", "overdue": "danger"}'
                           help="شريط التقدم يظهر حالة الأنشطة المجدولة للعمليات"/>
                
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click o_document_card o_workflow_card" 
                             t-attf-class="#{record.state.raw_value == 'active' ? 'o_card_active' : record.state.raw_value == 'testing' ? 'o_card_testing' : 'o_card_inactive'} #{record.success_rate.raw_value > 90 ? 'o_card_featured' : ''}"
                             t-attf-data-state="#{record.state.raw_value}"
                             t-attf-data-category="#{record.category.raw_value}">
                            
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_top_left">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge me-2" 
                                                  t-attf-class="#{record.state.raw_value === 'active' ? 'badge-success' : record.state.raw_value === 'testing' ? 'badge-warning' : 'badge-secondary'}">
                                                <i class="fa fa-play me-1" t-if="record.state.raw_value === 'active'"/>
                                                <i class="fa fa-flask me-1" t-if="record.state.raw_value === 'testing'"/>
                                                <i class="fa fa-pause me-1" t-if="record.state.raw_value === 'draft'"/>
                                                <t t-esc="record.state.value"/>
                                            </span>
                                            <span class="badge badge-info ms-1" t-if="record.code.raw_value">
                                                <i class="fa fa-code me-1"/>
                                                <t t-esc="record.code.value"/>
                                            </span>
                                        </div>
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                    </div>
                                    <div class="o_kanban_top_right">
                                        <div class="o_dropdown_kanban dropdown">
                                            <a role="button" class="dropdown-toggle o-no-caret btn" data-bs-toggle="dropdown" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                                <span class="fa fa-ellipsis-v"/>
                                            </a>
                                            <div class="dropdown-menu" role="menu">
                                                <a role="menuitem" class="dropdown-item oe_kanban_action oe_kanban_action_a" type="open">
                                                    <i class="fa fa-external-link me-2"/>عرض العملية
                                                </a>
                                                <a role="menuitem" class="dropdown-item oe_kanban_action oe_kanban_action_a" type="edit">
                                                    <i class="fa fa-edit me-2"/>تحرير
                                                </a>
                                                <div class="dropdown-divider"/>
                                                <t t-if="widget.deletable">
                                                    <a role="menuitem" class="dropdown-item oe_kanban_action oe_kanban_action_a" type="delete">
                                                        <i class="fa fa-trash me-2"/>حذف
                                                    </a>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="o_kanban_card_content">
                                <div class="o_kanban_tags_section mb-3">
                                    <div class="d-flex flex-wrap gap-1">
                                        <span class="o_kanban_tag o_kanban_tag_category" t-if="record.category.raw_value">
                                            <i class="fa fa-folder me-1"/>
                                            <field name="category"/>
                                        </span>
                                        <span class="o_kanban_tag o_kanban_tag_type" t-if="record.step_count.raw_value > 0">
                                            <i class="fa fa-list-ol me-1"/>
                                            <t t-esc="record.step_count.value"/> خطوة
                                        </span>
                                        <span class="o_kanban_tag o_kanban_tag_department" t-if="record.instance_count.raw_value > 0">
                                            <i class="fa fa-rocket me-1"/>
                                            <t t-esc="record.instance_count.value"/> تنفيذ
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_success_section mb-3" t-if="record.success_rate.raw_value > 0">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-muted d-flex align-items-center">
                                            <i class="fa fa-chart-line me-1"/>
                                            معدل النجاح
                                        </small>
                                        <small class="fw-bold" 
                                               t-attf-class="#{record.success_rate.raw_value >= 90 ? 'text-success' : record.success_rate.raw_value >= 70 ? 'text-warning' : 'text-danger'}">
                                            <t t-esc="record.success_rate.value"/>%
                                        </small>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" 
                                             t-attf-class="#{record.success_rate.raw_value >= 90 ? 'bg-success' : record.success_rate.raw_value >= 70 ? 'bg-warning' : 'bg-danger'}"
                                             t-attf-style="width: #{record.success_rate.value}%"
                                             t-attf-aria-valuenow="#{record.success_rate.value}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_stats_section mb-2">
                                    <div class="row text-center">
                                        <div class="col-4" t-if="record.step_count.raw_value > 0">
                                            <div class="text-primary fw-bold"><t t-esc="record.step_count.value"/></div>
                                            <small class="text-muted">خطوات</small>
                                        </div>
                                        <div class="col-4" t-if="record.instance_count.raw_value > 0">
                                            <div class="text-info fw-bold"><t t-esc="record.instance_count.value"/></div>
                                            <small class="text-muted">تنفيذ</small>
                                        </div>
                                        <div class="col-4" t-if="record.success_rate.raw_value > 0">
                                            <div class="text-success fw-bold"><t t-esc="record.success_rate.value"/>%</div>
                                            <small class="text-muted">نجاح</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="o_kanban_card_footer">
                                <div class="o_kanban_footer_left">
                                    <div class="o_kanban_footer_activity">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                </div>
                                <div class="o_kanban_footer_right">
                                    <div class="o_kanban_footer_meta">
                                        <small class="text-muted" t-if="record.write_date.raw_value">
                                            <i class="fa fa-clock-o me-1"/>
                                            <field name="write_date" widget="relative"/>
                                        </small>
                                    </div>
                                    <div class="o_kanban_click_indicator">
                                        <i class="fa fa-external-link text-primary" title="عرض التفاصيل"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="workflow_process_search_view" model="ir.ui.view">
        <field name="name">workflow.process.search</field>
        <field name="model">workflow.process</field>
        <field name="arch" type="xml">
            <search>
                <field name="name" string="العملية" filter_domain="[('name', 'ilike', self)]"/>
                <field name="code" string="الرمز"/>
                <field name="category" string="الفئة"/>
                <field name="owner_id" string="المالك"/>
                
                <filter string="نشط" name="active" domain="[('state', '=', 'active')]"/>
                <filter string="قيد الاختبار" name="testing" domain="[('state', '=', 'testing')]"/>
                <filter string="مسودة" name="draft" domain="[('state', '=', 'draft')]"/>
                <separator/>
                
                <filter string="أولوية عالية" name="high_priority" domain="[('priority', 'in', ['3', '4'])]"/>
                <filter string="تفعيل تلقائي" name="auto_trigger" domain="[('auto_trigger', '=', True)]"/>
                <separator/>
                
                <filter string="عملياتي" name="my_processes" domain="[('owner_id', '=', uid)]"/>
                <filter string="أدير عملياتها" name="managed_processes" domain="[('manager_ids', 'in', [uid])]"/>
                
                <group expand="0" string="تجميع حسب">
                    <filter string="الحالة" name="state" context="{'group_by': 'state'}"/>
                    <filter string="الفئة" name="category" context="{'group_by': 'category'}"/>
                    <filter string="نوع العملية" name="process_type" context="{'group_by': 'process_type'}"/>
                    <filter string="المالك" name="owner" context="{'group_by': 'owner_id'}"/>
                    <filter string="الأولوية" name="priority" context="{'group_by': 'priority'}"/>
                </group>
            </search>
        </field>
    </record>

    
    <record id="workflow_instance_tree_view" model="ir.ui.view">
        <field name="name">workflow.instance.tree</field>
        <field name="model">workflow.instance</field>
        <field name="arch" type="xml">
            <list decoration-info="state=='running'" decoration-success="state=='completed'" decoration-muted="state=='cancelled'">
                <field name="name"/>
                <field name="process_id"/>
                <field name="document_id"/>
                <field name="current_step_id"/>
                <field name="start_date"/>
                <field name="progress_percentage" widget="progressbar"/>
                <field name="state" widget="badge" decoration-info="state=='running'" decoration-success="state=='completed'" decoration-warning="state=='waiting'"/>
                <field name="is_test"/>
            </list>
        </field>
    </record>

    <record id="workflow_instance_form_view" model="ir.ui.view">
        <field name="name">workflow.instance.form</field>
        <field name="model">workflow.instance</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_cancel" string="إلغاء" type="object" invisible="state not in ('running', 'waiting')" confirm="هل أنت متأكد من إلغاء سير العمل؟"/>
                    <field name="state" widget="statusbar" statusbar_visible="running,waiting,completed"/>
                </header>
                
                <sheet>
                    <widget name="web_ribbon" title="تجريبي" bg_color="bg-warning" invisible="not is_test"/>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group>
                            <field name="process_id"/>
                            <field name="document_id"/>
                            <field name="current_step_id"/>
                        </group>
                        <group>
                            <field name="start_date"/>
                            <field name="completion_date"/>
                            <field name="progress_percentage" widget="progressbar"/>
                            <field name="is_test"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="تنفيذ الخطوات">
                            <field name="step_execution_ids" nolabel="1">
                                <list>
                                    <field name="step_id"/>
                                    <field name="assigned_user_id"/>
                                    <field name="start_date"/>
                                    <field name="completion_date"/>
                                    <field name="state" widget="badge"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="بيانات التفعيل">
                            <field name="trigger_data" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
                
                <chatter/>
            </form>
        </field>
    </record>

    <record id="workflow_instance_action" model="ir.actions.act_window">
        <field name="name">نسخ سير العمل</field>
        <field name="res_model">workflow.instance</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                لا توجد نسخ تنفيذ بعد!
            </p>
        </field>
    </record>

    </data>
</odoo>
